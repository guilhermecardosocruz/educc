

===== app/api/auth/login/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import bcrypt from "bcryptjs";
import { cookies } from "next/headers";

const schema = z.object({
  emailOrCpf: z.string().min(3),
  password: z.string().min(8)
});

const COOKIE_NAME = "session_user_id";

function onlyDigits(s: string){ return s.replace(/\D+/g, ""); }

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const parsed = schema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status: 400 });
    }
    const { emailOrCpf, password } = parsed.data;

    const byEmail = emailOrCpf.includes("@");
    const where = byEmail
      ? { email: emailOrCpf.toLowerCase() }
      : { cpf: onlyDigits(emailOrCpf) };

    const user = await prisma.user.findUnique({
      where,
      select: { id: true, name: true, email: true, passwordHash: true }
    });

    // resposta genérica para não dar dica
    const invalid = NextResponse.json({ ok:false, error: "Credenciais inválidas" }, { status: 401 });

    if (!user || !user.passwordHash) return invalid;

    const ok = await bcrypt.compare(password, user.passwordHash);
    if (!ok) return invalid;

    const c = await cookies();
    // cookie simples; se quiser, migramos para JWT com expiração/refresh
    c.set({
      name: COOKIE_NAME,
      value: user.id,
      httpOnly: true,
      path: "/",
      sameSite: "lax",
      // sem maxAge => cookie de sessão; podemos colocar expiração se preferir
    });

    return NextResponse.json({ ok:true, user: { id: user.id, name: user.name, email: user.email } });
  } catch (err:any) {
    return NextResponse.json({ ok:false, error: err?.message ?? "Erro" }, { status: 500 });
  }
}


===== app/api/auth/logout/route.ts =====
import { NextResponse } from "next/server";
import { clearSessionCookie } from "@/lib/session";

export async function POST() {
  try {
    await clearSessionCookie();
    return NextResponse.json({ ok:true });
  } catch {
    return NextResponse.json({ ok:false }, { status: 500 });
  }
}


===== app/api/auth/me/route.ts =====
import { NextResponse } from "next/server";
import { requireUser } from "@/lib/session";

export async function GET() {
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });
  return NextResponse.json({ ok:true, user });
}


===== app/api/auth/recover-email/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import crypto from "node:crypto";
import { sendRecoveryEmail } from "@/lib/email";

const schema = z.object({ email: z.string().email() });

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(()=> ({}));
    const parsed = schema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status: 400 });
    }

    const email = parsed.data.email.toLowerCase();
    const user = await prisma.user.findUnique({
      where: { email },
      select: { id: true, name: true }
    });

    // Não expomos existência do e-mail; mas só criamos token se existir.
    if (user) {
      const token = crypto.randomBytes(32).toString("hex");
      const expires = new Date(Date.now() + 1000 * 60 * 10); // 10 minutos

      await prisma.passwordResetToken.create({
        data: { token, userId: user.id, expiresAt: expires }
      });

      const base = process.env.APP_BASE_URL ?? "http://localhost:3000";
      const link = `${base}/reset/${token}`;

      const firstName = (user.name || "").split(" ")[0] || "Olá";
      const subject = "Recuperação de conta • EDUCC";
      const text =
`${firstName}, recebemos um pedido para recuperar sua conta EDUCC.
Abra este link em até 10 min: ${link}

Se não foi você, ignore este e-mail.`;
      const html =
`<p>${firstName}, recebemos um pedido para recuperar sua conta <b>EDUCC</b>.</p>
<p>Abra este link em até <b>10 min</b>: <a href="${link}">${link}</a></p>
<p>Se não foi você, ignore esta mensagem.</p>`;

      // Só envia se EMAIL_PROVIDER_ENABLED=true; senão, fica "no-op"
      await sendRecoveryEmail(email, subject, text, html);
    }

    // Sempre OK para não permitir enumeração de e-mails
    return NextResponse.json({ ok: true }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ ok:false, error: { message: err?.message ?? "Erro" } }, { status: 500 });
  }
}


===== app/api/auth/register/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { z } from "zod";
import bcrypt from "bcryptjs";

const schema = z.object({
  name: z.string().min(2),
  cpf: z.string().min(11),
  birthDate: z.string(), // ISO yyyy-mm-dd
  email: z.string().email(),
  phone: z.string().min(8),
  password: z.string().min(8, "A senha deve ter pelo menos 8 caracteres"),
  confirmPassword: z.string().min(8)
}).refine((d) => d.password === d.confirmPassword, {
  message: "As senhas não conferem",
  path: ["confirmPassword"]
});

function onlyDigits(s: string){ return s.replace(/\D+/g, ""); }

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const parsed = schema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status: 400 });
    }
    const { name, cpf, birthDate, email, phone, password } = parsed.data;

    const exists = await prisma.user.findFirst({
      where: { OR: [{ email: email.toLowerCase() }, { cpf: onlyDigits(cpf) }] },
      select: { id: true }
    });
    if (exists) {
      return NextResponse.json({ ok:false, error: "E-mail ou CPF já cadastrado" }, { status: 409 });
    }

    const passwordHash = await bcrypt.hash(password, 10);

    const user = await prisma.user.create({
      data: {
        name,
        cpf: onlyDigits(cpf),
        birthDate: new Date(birthDate),
        email: email.toLowerCase(),
        phone: onlyDigits(phone),
        passwordHash
      },
      select: { id: true, name: true, email: true }
    });

    // (opcional) já poderíamos criar sessão aqui — vou deixar a autenticação no /login
    return NextResponse.json({ ok:true, user }, { status: 201 });
  } catch (err:any) {
    return NextResponse.json({ ok:false, error: err?.message ?? "Erro" }, { status: 500 });
  }
}


===== app/api/classes/[id]/chamadas/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { z } from "zod";

const createSchema = z.object({
  title: z.string().trim().min(1).max(100).optional().default("Chamada")
});

// GET: lista chamadas (order por seq)
export async function GET(req: Request, ctx: { params: Promise<{ id: string }> }) {
  const { id } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok:false }, { status: 404 });

  const { searchParams } = new URL(req.url);
  const order = searchParams.get("order") === "asc" ? "asc" : "desc";

  const items = await prisma.attendance.findMany({
    where: { classId: id },
    orderBy: { seq: order },
    select: { id: true, seq: true, title: true, createdAt: true }
  });

  return NextResponse.json({ ok:true, attendances: items });
}

// POST: cria chamada e garante conteúdo com mesmo seq
export async function POST(req: Request, ctx: { params: Promise<{ id: string }> }) {
  const { id } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok:false }, { status: 404 });

  const body = await req.json().catch(()=> ({}));
  const parsed = createSchema.safeParse(body);
  if (!parsed.success) return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status: 400 });

  const result = await prisma.$transaction(async (tx) => {
    const last = await tx.attendance.findFirst({
      where: { classId: id },
      orderBy: { seq: "desc" },
      select: { seq: true }
    });
    const nextSeq = (last?.seq ?? 0) + 1;

    const attendance = await tx.attendance.create({
      data: { classId: id, seq: nextSeq, title: parsed.data.title || `Chamada ${nextSeq}` },
      select: { id: true, seq: true, title: true, createdAt: true }
    });

    // garante conteúdo com mesmo seq (se não existir)
    await tx.content.upsert({
      where: { classId_seq: { classId: id, seq: nextSeq } },
      update: {},
      create: {
        classId: id,
        seq: nextSeq,
        title: `Conteúdo ${nextSeq}`,
        bodyHtml: null
      }
    });

    return attendance;
  });

  return NextResponse.json({ ok:true, attendance: result }, { status: 201 });
}


===== app/api/classes/[id]/chamadas/[seq]/presences/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

type Body = {
  presences: { studentId: string; present: boolean }[];
};

export async function GET(_req: Request, { params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;
  const seqNum = Number(seq);
  const rows = await prisma.attendancePresence.findMany({
    where: { classId: id, seq: seqNum },
    select: { studentId: true, present: true },
    orderBy: { studentId: "asc" }
  });
  return NextResponse.json({ ok: true, rows });
}

export async function POST(req: Request, { params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;
  const seqNum = Number(seq);
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false, error: "Não autenticado" }, { status: 401 });

  // valida turma (dona do user; ajuste se usar outro ACL)
  const cls = await prisma.class.findFirst({
    where: { id, ownerId: user.id },
    select: { id: true }
  });
  if (!cls) return NextResponse.json({ ok: false, error: "Turma não encontrada." }, { status: 404 });

  let data: Body | null = null;
  try {
    data = (await req.json()) as Body;
  } catch {
    return NextResponse.json({ ok: false, error: "JSON inválido." }, { status: 400 });
  }

  if (!data?.presences || !Array.isArray(data.presences))
    return NextResponse.json({ ok: false, error: "Payload ausente: presences[]" }, { status: 400 });

  // upsert **todos** (present = true **ou** false)
  await prisma.$transaction(async (tx) => {
    for (const p of data!.presences) {
      if (!p?.studentId) continue;
      const deterministicId = `${id}:${seqNum}:${p.studentId}`;
      await tx.attendancePresence.upsert({
        where: { id: deterministicId },
        update: { present: !!p.present },
        create: {
          id: deterministicId,
          classId: id,
          seq: seqNum,
          studentId: p.studentId,
          present: !!p.present
        }
      });
    }
  });

  return NextResponse.json({ ok: true, saved: data.presences.length });
}


===== app/api/classes/[id]/chamadas/[seq]/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

export async function DELETE(_req: Request, ctx: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok: false, error: "Turma não encontrada" }, { status: 404 });

  const seqNum = Number(seq);
  if (!Number.isFinite(seqNum)) {
    return NextResponse.json({ ok: false, error: "Seq inválida" }, { status: 400 });
  }

  try {
    // tente pela chave composta (se existir)
    await prisma.attendance.delete({
      where: { classId_seq: { classId: id, seq: seqNum } as any },
    });
    return NextResponse.json({ ok: true });
  } catch (e1) {
    try {
      // fallback: sem unique composto => apaga pelo filtro
      await prisma.attendance.deleteMany({
        where: { classId: id, seq: seqNum },
      });
      return NextResponse.json({ ok: true });
    } catch (e2) {
      console.error("DELETE chamada erro:", e2);
      return NextResponse.json({ ok: false, error: "Erro ao excluir chamada" }, { status: 500 });
    }
  }
}


===== app/api/classes/[id]/conteudos/import/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

// CSV simples (com aspas) -> objetos
function parseCsv(text: string): Record<string,string>[] {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if (lines.length === 0) return [];
  const header = lines[0].split(",").map(h => h.trim());
  const rows: Record<string,string>[] = [];
  for (let i=1;i<lines.length;i++){
    const raw = lines[i];
    const cells: string[] = [];
    let cur = "", inside = false;
    for (let j=0;j<raw.length;j++){
      const ch = raw[j];
      if (ch === '"') { inside = !inside; continue; }
      if (ch === ',' && !inside) { cells.push(cur); cur = ""; continue; }
      cur += ch;
    }
    cells.push(cur);
    const obj: Record<string,string> = {};
    header.forEach((h, idx) => obj[h] = (cells[idx] ?? "").trim());
    rows.push(obj);
  }
  return rows;
}

function toBodyHtml(obj: {objetivos?: string; desenvolvimento?: string; recursos?: string; bncc?: string}) {
  const b = [];
  if (obj.objetivos) b.push(`<h3>Objetivos</h3><p>${obj.objetivos}</p>`);
  if (obj.desenvolvimento) b.push(`<h3>Desenvolvimento das Atividades</h3><p>${obj.desenvolvimento}</p>`);
  if (obj.recursos) b.push(`<h3>Recursos Pedagógicos</h3><p>${obj.recursos}</p>`);
  if (obj.bncc) b.push(`<h3>BNCC</h3><p>${obj.bncc}</p>`);
  return b.join("\n");
}

export async function POST(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok:false, error: "Turma não encontrada" }, { status: 404 });

  const form = await req.formData();
  const file = form.get("file") as File | null;
  if (!file) return NextResponse.json({ ok:false, error: "Arquivo ausente" }, { status: 400 });

  const name = (file.name || "").toLowerCase();
  if (name.endsWith(".xlsx")) {
    // Para suportar XLSX, adicione a lib "xlsx" e faça o parse aqui.
    // Ex.: const wb = XLSX.read(new Uint8Array(await file.arrayBuffer()), { type: "array" });
    // Por ora, retornamos instrução amigável:
    return NextResponse.json({
      ok:false,
      error:"XLSX ainda não habilitado no servidor. Envie CSV ou instale a dependência 'xlsx' e habilite o parser."
    }, { status: 415 });
  }

  const text = await file.text();
  const rows = parseCsv(text);
  if (rows.length === 0) return NextResponse.json({ ok:false, error: "Planilha vazia ou inválida" }, { status: 400 });

  // Campos aceitos: Nome da aula (obrigatório), objetivos, desenvolvimento das atividades, recursos pedagógicos, BNCC
  // Cabeçalhos esperados (case-insensitive): "nome da aula" | "aula" | "título", "objetivos", "desenvolvimento das atividades", "recursos pedagógicos", "bncc"
  const norm = (s:string) => s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();

  let created = 0, updated = 0;

  await prisma.$transaction(async (tx) => {
    // define seq auto pelo maior existente
    let last = await tx.content.findFirst({ where: { classId: id }, orderBy: { seq: "desc" }, select: { seq: true } });
    let seq = (last?.seq ?? 0);

    for (const r of rows) {
      const keys = Object.fromEntries(Object.keys(r).map(k => [norm(k), k]));
      const title = (r[keys[norm("nome da aula")] ?? keys["titulo"] ?? keys["aula"]] ?? "").toString().trim();
      if (!title) continue;

      const objetivos = (r[keys["objetivos"]] ?? "").toString().trim();
      const desenvolvimento = (r[keys[norm("desenvolvimento das atividades")]] ?? "").toString().trim();
      const recursos = (r[keys[norm("recursos pedagogicos")]] ?? "").toString().trim();
      const bncc = (r[keys["bncc"]] ?? "").toString().trim();

      seq += 1;

      await tx.content.create({
        data: {
          classId: id,
          seq,
          title,
          bodyHtml: toBodyHtml({ objetivos, desenvolvimento, recursos, bncc })
        }
      });
      created++;
    }
  });

  return NextResponse.json({ ok:true, created, updated });
}


===== app/api/classes/[id]/conteudos/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { z } from "zod";

// Monta um HTML simples com as seções opcionais, para persistência única
function toBodyHtml(obj: {objetivos?: string; desenvolvimento?: string; recursos?: string; bncc?: string}) {
  const b = [];
  if (obj.objetivos) b.push(`<h3>Objetivos</h3><p>${obj.objetivos}</p>`);
  if (obj.desenvolvimento) b.push(`<h3>Desenvolvimento das Atividades</h3><p>${obj.desenvolvimento}</p>`);
  if (obj.recursos) b.push(`<h3>Recursos Pedagógicos</h3><p>${obj.recursos}</p>`);
  if (obj.bncc) b.push(`<h3>BNCC</h3><p>${obj.bncc}</p>`);
  return b.join("\n");
}

const createSchema = z.object({
  title: z.string().trim().min(2, "Nome da aula é obrigatório"),
  objetivos: z.string().optional(),
  desenvolvimento: z.string().optional(),
  recursos: z.string().optional(),
  bncc: z.string().optional(),
});

export async function GET(_req: Request, { params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  // checa turma do usuário
  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok:false, error: "Turma não encontrada" }, { status: 404 });

  const list = await prisma.content.findMany({
    where: { classId: id },
    orderBy: { seq: "asc" },
    select: { id: true, seq: true, title: true }
  });

  return NextResponse.json({ ok:true, list });
}

export async function POST(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok:false, error: "Turma não encontrada" }, { status: 404 });

  const body = await req.json().catch(()=> ({}));
  const parsed = createSchema.safeParse(body);
  if (!parsed.success) return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status: 400 });

  // seq = último + 1
  const last = await prisma.content.findFirst({ where: { classId: id }, orderBy: { seq: "desc" }, select: { seq: true } });
  const nextSeq = (last?.seq ?? 0) + 1;

  const created = await prisma.content.create({
    data: {
      classId: id,
      seq: nextSeq,
      title: parsed.data.title,
      bodyHtml: toBodyHtml({
        objetivos: parsed.data.objetivos,
        desenvolvimento: parsed.data.desenvolvimento,
        recursos: parsed.data.recursos,
        bncc: parsed.data.bncc,
      }),
    },
    select: { id: true, seq: true, title: true }
  });

  return NextResponse.json({ ok:true, content: created }, { status: 201 });
}


===== app/api/classes/[id]/conteudos/[seq]/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { z } from "zod";

/** Serialização do bodyHtml em seções e vice-versa */
function toBodyHtml(obj: {objetivos?: string; desenvolvimento?: string; recursos?: string; bncc?: string}) {
  const b = [];
  if (obj.objetivos) b.push(`<h3>Objetivos</h3><p>${obj.objetivos}</p>`);
  if (obj.desenvolvimento) b.push(`<h3>Desenvolvimento das Atividades</h3><p>${obj.desenvolvimento}</p>`);
  if (obj.recursos) b.push(`<h3>Recursos Pedagógicos</h3><p>${obj.recursos}</p>`);
  if (obj.bncc) b.push(`<h3>BNCC</h3><p>${obj.bncc}</p>`);
  return b.join("\n");
}
function fromBodyHtml(html?: string) {
  const out: Record<string,string> = {};
  if (!html) return out;
  const get = (title: string) => {
    const re = new RegExp(`<h3>\\s*${title}\\s*<\\/h3>\\s*<p>([\\s\\S]*?)<\\/p>`, "i");
    const m = html.match(re);
    return m ? m[1] : "";
  };
  out.objetivos = get("Objetivos");
  out.desenvolvimento = get("Desenvolvimento das Atividades");
  out.recursos = get("Recursos Pedagógicos");
  out.bncc = get("BNCC");
  return out;
}

const patchSchema = z.object({
  title: z.string().trim().min(1).optional(), // "nome da aula" pode editar mas não é obrigatório no PATCH
  objetivos: z.string().optional(),
  desenvolvimento: z.string().optional(),
  recursos: z.string().optional(),
  bncc: z.string().optional(),
});

export async function GET(_req: Request, { params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id:true } });
  if (!cls) return NextResponse.json({ ok:false, error:"Turma não encontrada" }, { status:404 });

  const content = await prisma.content.findFirst({
    where: { classId: id, seq: Number(seq) },
    select: { id:true, seq:true, title:true, bodyHtml:true }
  });
  if (!content) return NextResponse.json({ ok:false, error:"Conteúdo não encontrado" }, { status:404 });

  const sections = fromBodyHtml(content.bodyHtml || "");
  return NextResponse.json({ ok:true, content: { ...content, ...sections } });
}

export async function PATCH(req: Request, { params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id:true } });
  if (!cls) return NextResponse.json({ ok:false, error:"Turma não encontrada" }, { status:404 });

  const body = await req.json().catch(()=> ({}));
  const parsed = patchSchema.safeParse(body);
  if (!parsed.success) return NextResponse.json({ ok:false, error: parsed.error.flatten() }, { status:400 });

  const current = await prisma.content.findFirst({
    where: { classId: id, seq: Number(seq) },
    select: { id:true, title:true, bodyHtml:true, seq:true }
  });
  if (!current) return NextResponse.json({ ok:false, error:"Conteúdo não encontrado" }, { status:404 });

  const existing = fromBodyHtml(current.bodyHtml || "");
  const merged = {
    objetivos: parsed.data.objetivos ?? existing.objetivos ?? "",
    desenvolvimento: parsed.data.desenvolvimento ?? existing.desenvolvimento ?? "",
    recursos: parsed.data.recursos ?? existing.recursos ?? "",
    bncc: parsed.data.bncc ?? existing.bncc ?? "",
  };

  const updated = await prisma.content.update({
    where: { id: current.id },
    data: {
      title: parsed.data.title ?? current.title,
      bodyHtml: toBodyHtml(merged),
    },
    select: { id:true, seq:true, title:true, bodyHtml:true }
  });

  return NextResponse.json({ ok:true, content: updated });
}

export async function DELETE(_req: Request, { params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id:true } });
  if (!cls) return NextResponse.json({ ok:false, error:"Turma não encontrada" }, { status:404 });

  const content = await prisma.content.findFirst({ where: { classId: id, seq: Number(seq) }, select: { id:true } });
  if (!content) return NextResponse.json({ ok:false, error:"Conteúdo não encontrado" }, { status:404 });

  await prisma.content.delete({ where: { id: content.id } });

  return NextResponse.json({ ok:true });
}


===== app/api/classes/[id]/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

export async function GET(_req: Request, ctx: { params: Promise<{ id: string }> }) {
  const { id } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const cls = await prisma.class.findFirst({
    where: { id, ownerId: user.id },
    select: { id: true, name: true }
  });
  if (!cls) return NextResponse.json({ ok:false }, { status: 404 });

  return NextResponse.json({ ok:true, class: cls });
}


===== app/api/classes/[id]/students/import/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

// Garantir Node.js (xlsx não roda no edge)
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

type Row = { name?: string; cpf?: string; contact?: string };

function norm(h: string) {
  return h
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "")
    .trim();
}

async function parseCSV(file: File): Promise<Row[]> {
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (!lines.length) return [];
  const headers = lines[0].split(/[,;|\t]/).map(norm);
  const out: Row[] = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(/[,;|\t]/);
    const row: any = {};
    headers.forEach((h, idx) => {
      const v = (cols[idx] ?? "").toString().trim();
      if (h === "name" || h === "nome") row.name = v;
      else if (h === "cpf") row.cpf = v;
      else if (h === "contact" || h === "contato" || h === "telefone" || h === "whatsapp") row.contact = v;
    });
    out.push(row);
  }
  return out;
}

async function parseXLSX(file: File): Promise<Row[]> {
  const ab = await file.arrayBuffer();
  const XLSX = await import("xlsx");
  const wb = XLSX.read(ab, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json: any[] = XLSX.utils.sheet_to_json(ws, { defval: "" });
  return json.map((r) => {
    const map: any = {};
    for (const k of Object.keys(r)) {
      const nk = norm(k);
      map[nk] = r[k];
    }
    const row: Row = {};
    row.name = (map["name"] ?? map["nome"] ?? "").toString().trim();
    row.cpf = (map["cpf"] ?? "").toString().trim();
    row.contact = (map["contact"] ?? map["contato"] ?? map["telefone"] ?? map["whatsapp"] ?? "").toString().trim();
    return row;
  });
}

export async function POST(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false, error: "Não autenticado" }, { status: 401 });

  const form = await req.formData().catch(() => null);
  const file = form?.get("file") as File | null;
  if (!file) return NextResponse.json({ ok: false, error: "Arquivo não enviado (campo 'file')." }, { status: 400 });

  const cls = await prisma.class.findFirst({
    where: { id, ownerId: user.id },
    select: { id: true }
  });
  if (!cls) return NextResponse.json({ ok: false, error: "Turma não encontrada." }, { status: 404 });

  try {
    const mime = (file.type || "").toLowerCase();
    const name = (file as any).name ? String((file as any).name).toLowerCase() : "";

    let rows: Row[] = [];

    // 1) CSV explícito por MIME ou extensão
    const looksCSV = mime.includes("csv") || name.endsWith(".csv");
    // 2) XLSX explícito por MIME ou extensão
    const looksXLSX = mime.includes("spreadsheet") || mime.includes("excel") || name.endsWith(".xlsx");

    if (looksXLSX) {
      rows = await parseXLSX(file);
    } else if (looksCSV) {
      rows = await parseCSV(file);
    } else {
      // Caso incerto (sem name e sem MIME confiável): tenta XLSX primeiro e cai pra CSV
      try {
        rows = await parseXLSX(file);
      } catch {
        rows = await parseCSV(file);
      }
    }

    const toInsert = rows
      .map(r => ({
        name: (r.name ?? "").toString().trim(),
        cpf: (r.cpf ?? "").toString().trim(),
        contact: (r.contact ?? "").toString().trim(),
      }))
      .filter(r => r.name.length > 0);

    if (!toInsert.length) {
      return NextResponse.json({ ok: false, error: "Planilha sem linhas válidas. A coluna 'name' é obrigatória." }, { status: 400 });
    }

    await prisma.$transaction(async (tx) => {
      for (const r of toInsert) {
        await tx.student.create({
          data: {
            classId: id,
            name: r.name,
            ...(r.cpf ? { cpf: r.cpf } : {}),
            ...(r.contact ? { contact: r.contact } : {}),
          },
        });
      }
    });

    return NextResponse.json({ ok: true, inserted: toInsert.length });
  } catch (e: any) {
    console.error("IMPORT students error:", e);
    const msg = e?.message || "Falha ao processar a planilha.";
    return NextResponse.json({ ok: false, error: msg }, { status: 500 });
  }
}


===== app/api/classes/[id]/students/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { z } from "zod";
import { Prisma } from "@prisma/client";

// trata string vazia como undefined
const emptyToUndef = z.string().transform(v => v.trim()).transform(v => v.length ? v : undefined).optional();

const createSchema = z.object({
  name: z.string().trim().min(2, "Nome muito curto"),
  cpf: emptyToUndef,
  contact: emptyToUndef,
});

export async function GET(_req: Request, ctx: { params: Promise<{ id: string }> }) {
  const { id } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok: false, error: "Turma não encontrada" }, { status: 404 });

  const students = await prisma.student.findMany({
    where: { classId: id },
    orderBy: { name: "asc" },
    select: { id: true, name: true, cpf: true, contact: true },
  });

  return NextResponse.json({ ok: true, students });
}

export async function POST(req: Request, ctx: { params: Promise<{ id: string }> }) {
  const { id } = await ctx.params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false }, { status: 401 });

  const cls = await prisma.class.findFirst({ where: { id, ownerId: user.id }, select: { id: true } });
  if (!cls) return NextResponse.json({ ok: false, error: "Turma não encontrada" }, { status: 404 });

  const parsed = createSchema.safeParse(await req.json().catch(() => ({})));
  if (!parsed.success) {
    return NextResponse.json({ ok: false, error: parsed.error.flatten() }, { status: 400 });
  }
  const { name, cpf, contact } = parsed.data;

  try {
    const student = await prisma.student.create({
      data: {
        name,
        classId: id,
        ...(cpf ? { cpf } : {}),
        ...(contact ? { contact } : {}),
      },
      select: { id: true, name: true, cpf: true, contact: true },
    });
    return NextResponse.json({ ok: true, student }, { status: 201 });
  } catch (err: any) {
    if (err instanceof Prisma.PrismaClientKnownRequestError) {
      if (err.code === "P2002") {
        return NextResponse.json({ ok: false, error: "Conflito de valor único (já existe)." }, { status: 409 });
      }
      if (err.code === "P2003") {
        return NextResponse.json({ ok: false, error: "Falha de integridade referencial." }, { status: 400 });
      }
    }
    console.error("POST /students error:", err);
    return NextResponse.json({ ok: false, error: "Erro interno ao criar aluno." }, { status: 500 });
  }
}


===== app/api/classes/[id]/students/[studentId]/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { z } from "zod";
import { Prisma } from "@prisma/client";

const schema = z.object({
  name: z.string().trim().min(2, "Nome muito curto"),
});

// PATCH /api/classes/:id/students/:studentId  -> editar nome
export async function PATCH(req: Request, { params }: { params: Promise<{ id: string; studentId: string }> }) {
  const { id, studentId } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false, error: "Não autenticado" }, { status: 401 });

  const exists = await prisma.student.findFirst({
    where: { id: studentId, classId: id, cls: { ownerId: user.id } },
    select: { id: true },
  });
  if (!exists) return NextResponse.json({ ok: false, error: "Aluno não encontrado" }, { status: 404 });

  const body = await req.json().catch(() => ({}));
  const parsed = schema.safeParse(body);
  if (!parsed.success) {
    return NextResponse.json({ ok: false, error: parsed.error.flatten() }, { status: 400 });
  }

  const updated = await prisma.student.update({
    where: { id: studentId },
    data: { name: parsed.data.name },
    select: { id: true, name: true, cpf: true, contact: true },
  });

  return NextResponse.json({ ok: true, student: updated });
}

// DELETE /api/classes/:id/students/:studentId -> excluir aluno
export async function DELETE(_req: Request, { params }: { params: Promise<{ id: string; studentId: string }> }) {
  const { id, studentId } = await params;
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok: false, error: "Não autenticado" }, { status: 401 });

  const exists = await prisma.student.findFirst({
    where: { id: studentId, classId: id, cls: { ownerId: user.id } },
    select: { id: true },
  });
  if (!exists) return NextResponse.json({ ok: false, error: "Aluno não encontrado" }, { status: 404 });

  try {
    await prisma.student.delete({ where: { id: studentId } });
    return NextResponse.json({ ok: true });
  } catch (err: any) {
    if (err instanceof Prisma.PrismaClientKnownRequestError && err.code === "P2003") {
      return NextResponse.json(
        { ok: false, error: "Não foi possível excluir: o aluno está vinculado a presenças." },
        { status: 409 }
      );
    }
    console.error("DELETE student error:", err);
    return NextResponse.json({ ok: false, error: "Erro interno ao excluir aluno." }, { status: 500 });
  }
}


===== app/api/classes/route.ts =====
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";

export async function GET() {
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });
  const classes = await prisma.class.findMany({
    where: { ownerId: user.id },
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true, createdAt: true }
  });
  return NextResponse.json({ ok:true, classes });
}

export async function POST(req: Request) {
  const user = await requireUser();
  if (!user) return NextResponse.json({ ok:false }, { status: 401 });

  const body = await req.json().catch(()=> ({}));
  const name = (body?.name ?? "").toString().trim();
  if (!name || name.length < 2) {
    return NextResponse.json({ ok:false, error: "Nome da turma inválido" }, { status: 400 });
  }

  const cls = await prisma.class.create({
    data: { name, ownerId: user.id },
    select: { id: true, name: true, createdAt: true }
  });

  return NextResponse.json({ ok:true, class: cls }, { status: 201 });
}


===== app/api/images/generate/route.ts =====
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { prompt } = await req.json().catch(() => ({}));
    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json({ error: "Defina OPENAI_API_KEY para habilitar geração de imagem." }, { status: 501 });
    }
    if (!prompt || String(prompt).trim().length === 0) {
      return NextResponse.json({ error: "Prompt inválido." }, { status: 400 });
    }

    // Exemplo com Images API (ajuste o endpoint/modelo conforme sua conta)
    const body = {
      model: "gpt-image-1",
      prompt: String(prompt),
      size: "1024x1024"
    };

    const r = await fetch("https://api.openai.com/v1/images/generations", {
      method: "POST",
      headers: {
        "authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
        "content-type": "application/json"
      },
      body: JSON.stringify(body)
    });

    const data: any = await r.json().catch(() => ({}));
    if (!r.ok || !data?.data?.[0]?.url) {
      return NextResponse.json({ error: data?.error?.message || "Falha ao gerar imagem" }, { status: 500 });
    }
    return NextResponse.json({ url: data.data[0].url });
  } catch (e: any) {
    return NextResponse.json({ error: e?.message || "Erro interno" }, { status: 500 });
  }
}


===== app/(auth)/login/page.tsx =====
import LoginCard from "@/components/LoginCard";

export default function LoginPage() {
  return (
    <main className="min-h-screen flex items-center justify-center p-6 bg-white">
      <LoginCard />
    </main>
  );
}


===== app/(auth)/recover-email/page.tsx =====
"use client";
import { useState } from "react";
import Link from "next/link";

export default function RecoverEmailPage() {
  const [email, setEmail] = useState("");
  const [loading, setLoading] = useState(false);
  const [done, setDone] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setErr(null);
    try {
      const res = await fetch("/api/auth/recover-email", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ email })
      });
      await res.json().catch(()=> ({}));
      setDone(true);
    } catch {
      setErr("Falha de rede. Tente novamente.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen grid grid-cols-1 lg:grid-cols-2">
      <section className="hidden lg:flex items-center justify-center bg-[var(--color-brand-blue)] text-white">
        <div className="max-w-xl px-8">
          <h2 className="text-4xl font-extrabold leading-tight">
            Recuperar conta por e-mail
          </h2>
          <p className="mt-4 text-white/90">
            Enviaremos um link de recuperação ao seu e-mail.
          </p>
        </div>
      </section>

      <section className="flex items-center justify-center p-6 lg:p-12">
        <div className="card p-8 max-w-md w-full">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <span className="inline-block h-4 w-4 rounded-full bg-[var(--color-brand-blue)]" />
              <span className="font-semibold">EDUCC</span>
            </div>
            <Link href="/login" className="text-sm text-[var(--color-brand-blue)] hover:underline">
              Voltar ao login
            </Link>
          </div>

          <h1 className="text-2xl font-semibold mb-1">Recuperar por e-mail</h1>
          <p className="text-sm text-gray-500 mb-6">Informe o e-mail cadastrado</p>

          {done ? (
            <div className="space-y-3">
              <p className="text-green-700">
                Se o e-mail existir, enviamos um link de recuperação. Verifique sua caixa de entrada.
              </p>
              <Link href="/login" className="btn-primary inline-flex justify-center">Voltar ao login</Link>
            </div>
          ) : (
            <form onSubmit={onSubmit} className="space-y-4">
              <div>
                <label className="block text-sm mb-1">E-mail</label>
                <input
                    className="input"
                    type="email"
                    placeholder="voce@exemplo.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    autoComplete="email"
                />
              </div>

              {err && <p className="text-sm text-red-600">{err}</p>}

              <button type="submit" className="btn-primary w-full" disabled={loading}>
                {loading ? "Enviando..." : "Enviar link"}
              </button>
            </form>
          )}
        </div>
      </section>
    </main>
  );
}


===== app/(auth)/recover/page.tsx =====
import { redirect } from "next/navigation";

export default function Page() {
  // redireciona imediatamente
  redirect("/recover-email");
}


===== app/(auth)/register/page.tsx =====
"use client";
import { useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";

// Helpers de máscara
function onlyDigits(s: string) { return s.replace(/\D+/g, ""); }

function maskCPF(v: string) {
  const d = onlyDigits(v).slice(0, 11);
  const p1 = d.slice(0,3);
  const p2 = d.slice(3,6);
  const p3 = d.slice(6,9);
  const p4 = d.slice(9,11);
  let out = p1;
  if (p2) out += "." + p2;
  if (p3) out += "." + p3;
  if (p4) out += "-" + p4;
  return out;
}

function maskPhoneBR(v: string) {
  const d = onlyDigits(v).slice(0, 11);
  const ddd = d.slice(0,2);
  const a = d.length > 10 ? d.slice(2,7) : d.slice(2,6);
  const b = d.length > 10 ? d.slice(7,11) : d.slice(6,10);
  let out = ddd ? `(${ddd}` : "";
  if (ddd && d.length >= 2) out += ") ";
  if (a) out += a;
  if (b) out += "-" + b;
  return out;
}

export default function RegisterPage() {
  const router = useRouter();
  const [form, setForm] = useState({
    name: "",
    cpf: "",
    birthDate: "",
    email: "",
    phone: "",
    password: "",
    confirmPassword: ""
  });
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  function update<K extends keyof typeof form>(k: K, v: string) {
    setForm((f) => ({ ...f, [k]: v }));
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setErr(null);

    // normalizações
    const email = form.email.trim().toLowerCase();
    const cpf = form.cpf.trim();
    const phone = form.phone.trim();
    const name = form.name.trim();

    if (form.password.length < 8) {
      setErr("A senha deve ter pelo menos 8 caracteres");
      setLoading(false);
      return;
    }
    if (form.password !== form.confirmPassword) {
      setErr("As senhas não conferem");
      setLoading(false);
      return;
    }
    // Validações básicas de client
    if (onlyDigits(cpf).length !== 11) {
      setErr("CPF inválido");
      setLoading(false);
      return;
    }
    const phoneDigits = onlyDigits(phone);
    if (!(phoneDigits.length === 10 || phoneDigits.length === 11)) {
      setErr("Telefone inválido");
      setLoading(false);
      return;
    }
    if (!form.birthDate) {
      setErr("Informe a data de nascimento");
      setLoading(false);
      return;
    }

    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          ...form,
          name,
          cpf,        // API já remove dígitos; máscara ok
          phone,      // idem
          email       // normalizado
        })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) {
        setErr(data?.error ?? "Erro ao criar conta");
      } else {
        router.push("/login");
      }
    } catch {
      setErr("Falha de rede. Tente novamente.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen grid grid-cols-1 lg:grid-cols-2">
      <section className="hidden lg:flex items-center justify-center bg-[var(--color-brand-blue)] text-white">
        <div className="max-w-xl px-8">
          <h2 className="text-4xl font-extrabold leading-tight">
            Crie sua conta EDUCC
          </h2>
          <p className="mt-4 text-white/90">
            Acesso rápido e seguro.
          </p>
        </div>
      </section>

      <section className="flex items-center justify-center p-6 lg:p-12">
        <div className="card p-8 max-w-lg w-full">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <span className="inline-block h-4 w-4 rounded-full bg-[var(--color-brand-blue)]" />
              <span className="font-semibold">EDUCC</span>
            </div>
            <Link href="/login" className="text-sm text-[var(--color-brand-blue)] hover:underline">
              Já tenho conta
            </Link>
          </div>

          <h1 className="text-2xl font-semibold mb-1">Criar conta</h1>
          <p className="text-sm text-gray-500 mb-6">Preencha seus dados</p>

          <form onSubmit={onSubmit} className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="sm:col-span-2">
              <label className="block text-sm mb-1">Nome completo</label>
              <input
                className="input"
                value={form.name}
                onChange={e=>update("name", e.target.value)}
                required
                autoComplete="name"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">CPF</label>
              <input
                className="input"
                inputMode="numeric"
                placeholder="000.000.000-00"
                value={form.cpf}
                onChange={(e)=> update("cpf", maskCPF(e.target.value))}
                maxLength={14}                             
                required
                pattern="^\d{3}\.\d{3}\.\d{3}-\d{2}$"
                title="Formato: 000.000.000-00"
                autoComplete="off"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Data de nascimento</label>
              <input
                className="input"
                type="date"
                value={form.birthDate}
                onChange={e=>update("birthDate", e.target.value)}
                required
                autoComplete="bday"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">E-mail</label>
              <input
                className="input"
                type="email"
                placeholder="voce@exemplo.com"
                value={form.email}
                onChange={(e)=> update("email", e.target.value.trim())}
                required
                autoComplete="email"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Telefone (Whats)</label>
              <input
                className="input"
                type="tel"
                inputMode="tel"
                placeholder="(00) 00000-0000"
                value={form.phone}
                onChange={(e)=> update("phone", maskPhoneBR(e.target.value))}
                maxLength={15}
                required
                pattern="^\(\d{2}\)\s?\d{4,5}-\d{4}$"
                title="Formato: (00) 00000-0000"
                autoComplete="tel"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Senha</label>
              <input
                className="input"
                type="password"
                value={form.password}
                onChange={e=>update("password", e.target.value)}
                required
                minLength={8}
                autoComplete="new-password"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Confirmar senha</label>
              <input
                className="input"
                type="password"
                value={form.confirmPassword}
                onChange={e=>update("confirmPassword", e.target.value)}
                required
                minLength={8}
                autoComplete="new-password"
              />
            </div>

            {err && <p className="sm:col-span-2 text-sm text-red-600">{err}</p>}

            <div className="sm:col-span-2">
              <button type="submit" className="btn-primary w-full" disabled={loading}>
                {loading ? "Criando..." : "Criar conta"}
              </button>
            </div>
          </form>
        </div>
      </section>
    </main>
  );
}


===== app/classes/[id]/chamadas/new/page.tsx =====
"use client";

import Link from "next/link";
import { useRouter, useParams } from "next/navigation";
import { useEffect, useMemo, useRef, useState } from "react";

type Student = { id: string; name: string; cpf: string | null; contact: string | null };

export default function NewCallPage() {
  const router = useRouter();
  const { id } = useParams<{ id: string }>();

  const [title, setTitle] = useState("");
  const [students, setStudents] = useState<Student[]>([]);
  const [presence, setPresence] = useState<Record<string, boolean>>({});
  const [saving, setSaving] = useState(false);

  // Adicionar aluno
  const [showAdd, setShowAdd] = useState(false);
  const [newName, setNewName] = useState("");
  const [newCpf, setNewCpf] = useState("");
  const [newContact, setNewContact] = useState("");
  const [adding, setAdding] = useState(false);

  // Import planilha
  const [uploadName, setUploadName] = useState<string | null>(null);
  const [uploadFile, setUploadFile] = useState<File | null>(null);
  const [importing, setImporting] = useState(false);
  const fileRef = useRef<HTMLInputElement | null>(null);

  // Editar aluno (modal)
  const [editId, setEditId] = useState<string | null>(null);
  const [editName, setEditName] = useState("");

  useEffect(() => {
    (async () => {
      if (!id) return;
      const res = await fetch(`/api/classes/${id}/students`, { cache: "no-store" });
      const data = await res.json();
      if (data?.ok && Array.isArray(data.students)) {
        setStudents(data.students);
        const initial: Record<string, boolean> = {};
        for (const s of data.students) initial[s.id] = true;
        setPresence(initial);
      }
    })();
  }, [id]);

  function toggleStudent(studentId: string) {
    setPresence((p) => ({ ...p, [studentId]: !p[studentId] }));
  }
  function setAll(v: boolean) {
    const all: Record<string, boolean> = {};
    for (const s of students) all[s.id] = v;
    setPresence(all);
  }

  // Modal editar (duplo clique no nome)
  function onDblClickStudent(st: Student) {
    setEditId(st.id);
    setEditName(st.name);
  }
  async function handleEditSave() {
    if (!id || !editId) return;
    const name = editName.trim();
    if (name.length < 2) {
      alert("Informe o nome (mínimo 2 caracteres).");
      return;
    }
    try {
      const res = await fetch(`/api/classes/${id}/students/${editId}`, {
        method: "PATCH",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ name }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      setStudents((prev) => prev.map((s) => (s.id === editId ? { ...s, name } : s)));
      setEditId(null);
      setEditName("");
    } catch (e: any) {
      alert(e?.message || "Erro ao salvar");
      console.error(e);
    }
  }
  async function handleEditDelete() {
    if (!id || !editId) return;
    if (!confirm("Tem certeza que deseja excluir este aluno?")) return;
    try {
      const res = await fetch(`/api/classes/${id}/students/${editId}`, { method: "DELETE" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      setStudents(prev => prev.filter(s => s.id !== editId));
      setPresence(prev => { const c = { ...prev }; delete c[editId!]; return c; });
      setEditId(null);
      setEditName("");
    } catch (e: any) {
      alert("Erro ao excluir aluno");
      console.error(e);
    }
  }

  // Adicionar aluno
  async function handleAddStudent() {
    if (!id) return;
    const name = newName.trim();
    const cpf = newCpf.trim();
    const contact = newContact.trim();
    if (name.length < 2) {
      alert("Informe o nome (mínimo 2 caracteres).");
      return;
    }
    setAdding(true);
    try {
      const body: any = { name };
      if (cpf.length) body.cpf = cpf;
      if (contact.length) body.contact = contact;

      const res = await fetch(`/api/classes/${id}/students`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body)
      });
      let payload: any = null;
      try { payload = await res.json(); } catch {}
      if (!res.ok || !payload?.ok) {
        let msg = "Erro ao adicionar aluno";
        const e = payload?.error;
        if (typeof e === "string") msg = e;
        else if (e?.formErrors?.formErrors?.length) msg = e.formErrors.formErrors.join("\n");
        else if (e?.fieldErrors) msg = JSON.stringify(e.fieldErrors);
        throw new Error(msg);
      }

      const st: Student = payload.student;
      setStudents((prev) => [st, ...prev]);
      setPresence((p) => ({ ...p, [st.id]: true }));
      setNewName(""); setNewCpf(""); setNewContact("");
      setShowAdd(false);
    } catch (e: any) {
      alert(e?.message || "Erro ao adicionar aluno");
      console.error(e);
    } finally {
      setAdding(false);
    }
  }

  // Importação CSV/XLSX
  async function handleImportSend() {
    if (!id || !uploadFile) {
      alert("Selecione um arquivo CSV/XLSX antes de enviar.");
      return;
    }
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", uploadFile);
      const res = await fetch(`/api/classes/${id}/students/import`, { method: "POST", body: fd });
      const data = await res.json();
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      const res2 = await fetch(`/api/classes/${id}/students`, { cache: "no-store" });
      const data2 = await res2.json();
      if (data2?.ok && Array.isArray(data2.students)) {
        setStudents(data2.students);
        const next: Record<string, boolean> = {};
        for (const s of data2.students) next[s.id] = true;
        setPresence(next);
      }
      setUploadName(null); setUploadFile(null);
      if (fileRef.current) fileRef.current.value = "";
    } catch (e) {
      const __m = (e && (e as any).message) ? (e as any).message : String(e || "Erro ao importar planilha"); alert(__m);
      console.error(e);
    } finally {
      setImporting(false);
    }
  }

  // Criar chamada + presenças
  async function handleCreate() {
    if (!id) return;
    setSaving(true);
    try {
      const res = await fetch(`/api/classes/${id}/chamadas`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ title: title.trim() || undefined })
      });
      const data = await res.json();
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      const seq: number = data.attendance.seq;
      const presences = students.map((s) => ({ studentId: s.id, present: !!presence[s.id] }));

      const res2 = await fetch(`/api/classes/${id}/chamadas/${seq}/presences`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ presences })
      });
      const d2 = await res2.json();
      if (!res2.ok || !d2?.ok) throw new Error(d2?.error || "Falha ao salvar presenças");

      router.push(`/classes/${id}/chamadas`);
    } catch (e) {
      alert("Erro ao criar/salvar chamada");
      console.error(e);
    } finally {
      setSaving(false);
    }
  }

  const totalPresentes = useMemo(
    () => students.reduce((acc, s) => acc + (presence[s.id] ? 1 : 0), 0),
    [students, presence]
  );

  // Importação CSV/XLSX (escopo local do componente)
  const __handleImportSend = async () => {
    if (!id || !uploadFile) {
      alert("Selecione um arquivo CSV/XLSX antes de enviar.");
      return;
    }
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", uploadFile);
      const res = await fetch(`/api/classes/${id}/students/import`, { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      // Recarregar alunos e refazer mapa de presenças (marca todos como presentes)
      const res2 = await fetch(`/api/classes/${id}/students`, { cache: "no-store" });
      const data2 = await res2.json().catch(() => ({}));
      if (data2?.ok && Array.isArray(data2.students)) {
        setStudents(data2.students);
        setPresence((prev) => {
    const n: Record<string, boolean> = { ...(prev || {}) };
    for (const st of data2.students) {
      if (!(st.id in n)) n[st.id] = true; // só marca presentes os NOVOS
    }
    return n;
  });
      }
      setUploadName(null);
      setUploadFile(null);
      if (fileRef.current) fileRef.current.value = "";
    } catch (e) {
      const __m = (e && (e as any).message) ? (e as any).message : String(e || "Erro ao importar planilha"); alert(__m);
      console.error(e);
    } finally {
      setImporting(false);
    }
  };

  return (
    <main className="mx-auto max-w-5xl px-4 py-6">
      <nav className="mb-4 text-sm">
        <Link href={`/classes/${id}/chamadas`} className="text-blue-700 hover:underline">Voltar para Chamadas</Link>
      </nav>

      <section className="rounded-2xl border bg-white/90 shadow-soft ring-1 ring-black/5">
        <div className="flex flex-wrap items-center justify-between gap-3 border-b px-5 py-4">
          <div>
            <h1 className="text-xl font-semibold text-gray-900">Nova chamada</h1>
            <p className="text-sm text-gray-600">Marque a presença e crie a chamada desta aula.</p>
          </div>
          <div className="text-right">
            <div className="text-xs text-gray-500">Nome da aula</div>
            <input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Ex.: Aula 01 - Introdução"
              className="mt-1 w-64 rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
        </div>

        <div className="space-y-5 px-5 py-5">
          {/* Adicionar aluno */}
          {showAdd && (
            <div className="rounded-2xl border bg-blue-50/40 px-4 py-3">
              <div className="grid gap-3 md:grid-cols-3">
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">Nome</label>
                  <input
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    placeholder="Ex.: Maria Silva"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">CPF (opcional)</label>
                  <input
                    value={newCpf}
                    onChange={(e) => setNewCpf(e.target.value)}
                    placeholder="Somente números"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">Contato (opcional)</label>
                  <input
                    value={newContact}
                    onChange={(e) => setNewContact(e.target.value)}
                    placeholder="Ex.: (48) 99999-9999"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
              </div>
              <div className="mt-3 flex items-center gap-2">
                <button
                  type="button"
                  onClick={handleAddStudent}
                  disabled={adding || newName.trim().length < 2}
                  className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60"
                >
                  {adding ? "Adicionando..." : "Salvar aluno"}
                </button>
                <button
                  type="button"
                  onClick={() => { setShowAdd(false); setNewName(""); setNewCpf(""); setNewContact(""); }}
                  className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
                >
                  Cancelar
                </button>
              </div>
            </div>
          )}

          {/* Lista de presença */}
          <div className="rounded-2xl overflow-hidden border">
            <div className="flex items-center justify-between bg-blue-600 px-4 py-3 text-white">
              <div className="font-semibold">Lista de presença</div>
              <div className="text-sm">Presentes: <b>{totalPresentes}</b> / {students.length}</div>
            </div>

            <div className="flex flex-wrap items-center gap-2 border-b bg-blue-50 px-4 py-2 text-sm">
              <button className="rounded-lg border border-blue-200 px-3 py-1 hover:bg-blue-100" onClick={() => setAll(true)}>Marcar todos</button>
              <button className="rounded-lg border border-blue-200 px-3 py-1 hover:bg-blue-100" onClick={() => setAll(false)}>Desmarcar todos</button>
            </div>

            <div className="grid grid-cols-[32px_1fr_36px] border-b border-blue-200 bg-blue-100/70 text-sm font-medium text-blue-900">
              <div className="px-1.5 py-2 text-center">#</div>
              <div className="px-3 py-2">Aluno</div>
              <div className="px-1.5 py-2 text-center"><span className="sr-only">Presença</span></div>
            </div>

            <div className="max-h-[60vh] overflow-auto">
              {students.length === 0 ? (
                <div className="px-4 py-6 text-sm text-gray-600">Nenhum aluno cadastrado nesta turma.</div>
              ) : students.map((s, idx) => {
                const isEven = idx % 2 === 0;
                return (
                  <div
                    key={s.id}
                    className={[
                      "grid grid-cols-[32px_1fr_36px] items-center text-sm",
                      "border-b border-blue-100",
                      isEven ? "bg-blue-50/40" : "bg-white"
                    ].join(" ")}
                  >
                    <div className="px-1.5 py-2 text-center text-gray-600 tabular-nums">{idx + 1}</div>
                    <div className="px-3 py-2">
                      <div
                        className="font-medium text-gray-900 cursor-pointer select-none"
                        onDoubleClick={() => onDblClickStudent(s)}
                        title="Duplo clique para editar"
                      >
                        {s.name}
                      </div>
                    </div>
                    <div className="px-1.5 py-2 text-center">
                      <label className="inline-flex items-center">
                        <span className="sr-only">Presença de {s.name}</span>
                        <input
                          type="checkbox"
                          className="h-4 w-4 accent-blue-600"
                          checked={!!presence[s.id]}
                          onChange={() => toggleStudent(s.id)}
                          aria-label={`Presença de ${s.name}`}
                        />
                      </label>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Barra de ações — abaixo da lista */}
          <div className="flex flex-wrap items-center gap-2">
            <button
              type="button"
              onClick={handleCreate}
              disabled={saving}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90 disabled:opacity-60"
            >
              {saving ? "Salvando..." : "Criar chamada"}
            </button>
            <button
              type="button"
              onClick={() => setShowAdd((s) => !s)}
              className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
            >
              Adicionar aluno
            </button>
          </div>

          {/* Importação (CSV/XLSX) */}
          <div className="rounded-2xl border">
            <div className="border-b px-4 py-3">
              <h3 className="text-sm font-medium text-gray-900">Adicionar alunos por planilha</h3>
              <p className="text-xs text-gray-600 mt-1">
                <b>Apenas o campo "name" é obrigatório</b>. "cpf" e "contact" são opcionais.
              </p>
            </div>

            <div className="grid gap-3 px-4 py-4">
              <div className="flex flex-col items-center justify-center rounded-xl border border-dashed border-blue-300 bg-blue-50/40 px-6 py-8 text-center">
                <p className="text-sm font-medium text-gray-800">Selecione seu arquivo CSV/XLSX</p>
                <p className="text-xs text-gray-500">Formatos aceitos: .csv, .xlsx</p>

                <div className="mt-3 flex flex-wrap items-center justify-center gap-2">
                  <input
                    type="file"
                    accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    className="hidden"
                    id="students-file-input"
                    ref={fileRef}
                    onChange={(e) => {
                      const f = e.target.files?.[0] || null;
                      setUploadName(f ? f.name : null);
                      setUploadFile(f);
                    }}
                  />
                  <label
                    htmlFor="students-file-input"
                    className="cursor-pointer rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600"
                  >
                    Escolher arquivo
                  </label>

                  <button
                    type="button"
                    onClick={__handleImportSend}
                    disabled={!uploadFile || importing}
                    className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60"
                  >
                    {importing ? "Enviando..." : "Enviar planilha"}
                  </button>
                </div>

                {uploadName && <div className="mt-2 text-xs text-gray-700">Selecionado: {uploadName}</div>}

                <div className="mt-4 flex flex-wrap items-center justify-center gap-2 text-sm">
                  <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/students.csv" target="_blank" rel="noreferrer">
                    Baixar modelo CSV
                  </a>
                  <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/students.xlsx" target="_blank" rel="noreferrer">
                    Baixar modelo XLSX
                  </a></div>
              </div>
            </div>
          </div>
        </div>{/* /px-5 py-5 */}
      </section>

      {/* MODAL editar aluno */}
      {editId && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
          <div className="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
            <h2 className="text-lg font-semibold text-gray-900">Editar aluno</h2>
            <div className="mt-3 grid gap-2">
              <label className="text-xs font-medium text-gray-700">Nome</label>
              <input
                value={editName}
                onChange={(e) => setEditName(e.target.value)}
                className="w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                placeholder="Nome do aluno"
              />
            </div>
            <div className="mt-4 flex items-center gap-2">
              <button
                type="button"
                onClick={handleEditSave}
                className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
              >
                Salvar
              </button>
              <button
                type="button"
                onClick={() => { setEditId(null); setEditName(""); }}
                className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={handleEditDelete}
                className="rounded-xl border border-red-300 bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100"
              >
                Excluir aluno
              </button>
            </div>
          </div>
        </div>
      )}
    </main>
  );
}


===== app/classes/[id]/chamadas/page.tsx =====
import Link from "next/link";
import { prisma } from "@/lib/prisma";

export const dynamic = "force-dynamic";

export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;

  const cls = await prisma.class.findFirst({
    where: { id },
    select: { id: true, name: true }
  });

  if (!cls) {
    return (
      <main className="mx-auto max-w-5xl px-6 py-10">
        <div className="rounded-2xl border bg-white p-8 text-center">
          <p className="text-lg font-medium text-gray-700">Turma não encontrada.</p>
          <Link
            href="/classes"
            className="mt-4 inline-flex rounded-xl bg-[#0A66FF] px-4 py-2 text-white shadow hover:opacity-90"
          >
            Voltar
          </Link>
        </div>
      </main>
    );
  }

  const attendances = await prisma.attendance.findMany({
    where: { classId: cls.id },
    orderBy: [{ seq: "desc" }],
    select: { seq: true, title: true }
  });

  return (
    <main className="mx-auto max-w-5xl px-6 py-10">
      {/* Cabeçalho */}
      <div className="rounded-2xl border bg-white/90 backdrop-blur p-6 shadow-sm">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <Link
              href={`/classes/${cls.id}`}
              className="inline-flex items-center gap-2 rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-[#0A66FF]"
            >
              Voltar
            </Link>
          </div>

          <div className="text-right">
            <h1 className="text-xl font-semibold text-gray-900">
              Chamadas — <span className="text-[#0A66FF]">{cls.name}</span>
            </h1>
            <p className="mt-1 text-sm text-gray-600">Gerencie as chamadas desta turma.</p>
          </div>

          <Link
            href={`/classes/${cls.id}/chamadas/new`}
            className="inline-flex items-center gap-2 rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-[#0A66FF]"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden className="-ms-1">
              <path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/>
            </svg>
            Nova chamada
          </Link>
        </div>
      </div>

      {/* Lista */}
      <section className="mt-6">
        <div className="rounded-2xl border bg-white shadow-sm">
          {attendances.length === 0 ? (
            <div className="p-8 text-center">
              <p className="text-gray-700">Ainda não há chamadas nesta turma.</p>
              <Link
                href={`/classes/${cls.id}/chamadas/new`}
                className="mt-4 inline-flex items-center gap-2 rounded-xl border border-[#0A66FF] px-4 py-2 text-sm font-medium text-[#0A66FF] hover:bg-[#0A66FF] hover:text-white focus:outline-none focus:ring-2 focus:ring-[#0A66FF]"
              >
                Criar primeira chamada
              </Link>
            </div>
          ) : (
            <ul className="divide-y divide-blue-100">
              {attendances.map((att) => (
                <li key={att.seq} className="odd:bg-blue-50/40 even:bg-blue-100/30">
                  <Link
                    href={`/classes/${cls.id}/chamadas/${att.seq}`}
                    className="group block px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-[#0A66FF]"
                    title={att.title || `Chamada ${att.seq}`}
                  >
                    <div className="flex items-center justify-between">
                      <p className="truncate text-[15px] font-semibold text-gray-900">
                        {att.seq} — {att.title?.trim() ? att.title : "Sem título"}
                      </p>
                      <div className="ms-4 shrink-0 rounded-full bg-[#0A66FF]/10 p-2 text-[#0A66FF] transition group-hover:bg-[#0A66FF]/20">
                        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden>
                          <path fill="currentColor" d="M9 6l6 6l-6 6"/>
                        </svg>
                      </div>
                    </div>
                  </Link>
                </li>
              ))}
            </ul>
          )}
        </div>
      </section>
    </main>
  );
}


===== app/classes/[id]/chamadas/[seq]/page.tsx =====
import { prisma } from "@/lib/prisma";
import { requireUser } from "@/lib/session";
import { notFound, redirect } from "next/navigation";
import ChamadaClient from "./ui";

export default async function ChamadaPage({ params }: { params: Promise<{ id: string; seq: string }> }) {
  const { id, seq } = await params;

  const user = await requireUser();
  if (!user) redirect("/login");

  const cls = await prisma.class.findFirst({
    where: { id, ownerId: user.id },
    select: { id: true, name: true }
  });
  if (!cls) notFound();

  // dados iniciais para preencher o client
  const attendance = await prisma.attendance.findUnique({
    where: { classId_seq: { classId: id, seq: Number(seq) } },
    select: { seq: true, title: true }
  });
  if (!attendance) notFound();

  const students = await prisma.student.findMany({
    where: { classId: id },
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true, cpf: true, contact: true }
  });


  // carrega presenças salvas para esta chamada
  const presences = await prisma.attendancePresence.findMany({
    where: { classId: cls.id, seq: attendance.seq },
    select: { studentId: true, present: true }
  });
  const initialPresence = Object.fromEntries(presences.map(r => [r.studentId, !!r.present]));
  return <ChamadaClient classId={cls.id} className={cls.name} seq={attendance.seq} initialTitle={attendance.title} initialStudents={students} initialPresence={initialPresence}  />;
}


===== app/classes/[id]/chamadas/[seq]/ui.tsx =====
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useMemo, useRef, useState } from "react";

type Student = { id: string; name: string; cpf: string | null; contact: string | null };

export default function EditChamadaClient({
  classId,
  className,
  seq,
  initialTitle,
  initialStudents
}: {
  classId: string;
  className: string;
  seq: number;
  initialTitle: string;
  initialStudents: Student[]; initialPresence?: Record<string, boolean>; }) {
  const router = useRouter();

  const [title, setTitle] = useState(initialTitle || "");
  const [students, setStudents] = useState<Student[]>(initialStudents || []);
  const [presence, setPresence] = useState<Record<string, boolean>>({});
  const [saving, setSaving] = useState(false);
  const [deleting, setDeleting] = useState(false);

  // Adicionar aluno
  const [showAdd, setShowAdd] = useState(false);
  const [newName, setNewName] = useState("");
  const [newCpf, setNewCpf] = useState("");
  const [newContact, setNewContact] = useState("");
  const [adding, setAdding] = useState(false);

  // Import planilha
  const [uploadName, setUploadName] = useState<string | null>(null);
  const [uploadFile, setUploadFile] = useState<File | null>(null);
  const [importing, setImporting] = useState(false);
  const fileRef = useRef<HTMLInputElement | null>(null);

  // Editar aluno (modal)
  const [editId, setEditId] = useState<string | null>(null);
  const [editName, setEditName] = useState("");

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch(`/api/classes/${classId}/chamadas/${seq}/presences`, { cache: "no-store" });
        if (!res.ok) throw new Error();
        const data = await res.json();
        const map: Record<string, boolean> = {};
        if (Array.isArray(data?.rows)) {
          for (const r of data.rows) map[r.studentId] = !!r.present;
        } else {
          for (const s of initialStudents) map[s.id] = true;
        }
        setPresence(map);
      } catch {
        const map: Record<string, boolean> = {};
        for (const s of initialStudents) map[s.id] = true;
        setPresence(map);
      }
    })();
  }, [classId, seq, initialStudents]);

  function toggleStudent(studentId: string) {
    setPresence((p) => ({ ...p, [studentId]: !p[studentId] }));
  }
  function setAll(v: boolean) {
    const all: Record<string, boolean> = {};
    for (const s of students) all[s.id] = v;
    setPresence(all);
  }

  // Modal editar
  function onDblClickStudent(st: Student) {
    setEditId(st.id);
    setEditName(st.name);
  }
  async function handleEditSave() {
    if (!editId) return;
    const name = editName.trim();
    if (name.length < 2) {
      alert("Informe o nome (mínimo 2 caracteres).");
      return;
    }
    try {
      const res = await fetch(`/api/classes/${classId}/students/${editId}`, {
        method: "PATCH",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ name }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      setStudents((prev) => prev.map((s) => (s.id === editId ? { ...s, name } : s)));
      setEditId(null);
      setEditName("");
    } catch (e: any) {
      alert(e?.message || "Erro ao salvar");
      console.error(e);
    }
  }
  async function handleEditDelete() {
    if (!editId) return;
    if (!confirm("Tem certeza que deseja excluir este aluno?")) return;
    try {
      const res = await fetch(`/api/classes/${classId}/students/${editId}`, { method: "DELETE" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      setStudents(prev => prev.filter(s => s.id !== editId));
      setPresence(prev => { const c = { ...prev }; delete c[editId!]; return c; });
      setEditId(null);
      setEditName("");
    } catch (e: any) {
      alert("Erro ao excluir aluno");
      console.error(e);
    }
  }

  // Salvar presenças
  async function handleSave() {
    setSaving(true);
    try {
      const presences = students.map((s) => ({ studentId: s.id, present: !!presence[s.id] }));
      const res = await fetch(`/api/classes/${classId}/chamadas/${seq}/presences`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ presences })
      });
      const d = await res.json();
      if (!res.ok || !d?.ok) throw new Error(d?.error || "Falha ao salvar presenças");
      alert("Chamada atualizada com sucesso.");
    } catch (e: any) {
      alert(e?.message || "Erro ao salvar chamada");
      console.error(e);
    } finally {
      setSaving(false);
    }
  }

  // Excluir chamada
  async function handleDelete() {
    if (!confirm("Tem certeza que deseja excluir esta chamada? Esta ação não pode ser desfeita.")) return;
    setDeleting(true);
    try {
      const res = await fetch(`/api/classes/${classId}/chamadas/${seq}`, { method: "DELETE" });
      const d = await res.json().catch(() => ({}));
      if (!res.ok || !d?.ok) throw new Error(d?.error || "Falha ao excluir chamada");
      router.push(`/classes/${classId}/chamadas`);
    } catch (e: any) {
      alert(e?.message || "Erro ao excluir chamada");
      console.error(e);
    } finally {
      setDeleting(false);
    }
  }

  // Adicionar aluno
  async function handleAddStudent() {
    const name = newName.trim();
    const cpf = newCpf.trim();
    const contact = newContact.trim();
    if (name.length < 2) {
      alert("Informe o nome (mínimo 2 caracteres).");
      return;
    }

  // Importação CSV/XLSX
  async function handleImportSend() {
    if (!classId || !uploadFile) {
      alert("Selecione um arquivo CSV/XLSX antes de enviar.");
      return;
    }
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", uploadFile);
      const res = await fetch(`/api/classes/${classId}/students/import`, { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      // Recarrega alunos e refaz mapa de presenças (marca todos como presentes por padrão)
      const res2 = await fetch(`/api/classes/${classId}/students`, { cache: "no-store" });
      const data2 = await res2.json().catch(() => ({}));
      if (data2?.ok && Array.isArray(data2.students)) {
        setStudents(data2.students);
        setPresence((prev) => {
    const n: Record<string, boolean> = { ...(prev || {}) };
    for (const st of data2.students) {
      if (!(st.id in n)) n[st.id] = true; // só marca presentes os NOVOS
    }
    return n;
  });
      }
      setUploadName(null);
      setUploadFile(null);
      if (fileRef.current) fileRef.current.value = "";
    } catch (e) {
      const __m = (e && (e as any).message) ? (e as any).message : String(e || "Erro ao importar planilha"); alert(__m);
      console.error(e);
    } finally {
      setImporting(false);
    }
  }
    setAdding(true);
    try {
      const body: any = { name };
      if (cpf.length) body.cpf = cpf;
      if (contact.length) body.contact = contact;

      const res = await fetch(`/api/classes/${classId}/students`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body)
      });
      let payload: any = null;
      try { payload = await res.json(); } catch {}
      if (!res.ok || !payload?.ok) {
        let msg = "Erro ao adicionar aluno";
        const e = payload?.error;
        if (typeof e === "string") msg = e;
        else if (e?.formErrors?.formErrors?.length) msg = e.formErrors.formErrors.join("\n");
        else if (e?.fieldErrors) msg = JSON.stringify(e.fieldErrors);
        throw new Error(msg);
      }

      const st: Student = payload.student;
      setStudents((prev) => [st, ...prev]);
      setPresence((p) => ({ ...p, [st.id]: true }));
      setNewName(""); setNewCpf(""); setNewContact("");
      setShowAdd(false);
    } catch (e: any) {
      alert(e?.message || "Erro ao adicionar aluno");
      console.error(e);
    } finally {
      setAdding(false);
    }
  }

  const totalPresentes = useMemo(
    () => students.reduce((acc, s) => acc + (presence[s.id] ? 1 : 0), 0),
    [students, presence]
  );

  // Importação CSV/XLSX (escopo local do componente)
  const __handleImportSend = async () => {
    if (!classId || !uploadFile) {
      alert("Selecione um arquivo CSV/XLSX antes de enviar.");
      return;
    }
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", uploadFile);
      const res = await fetch(`/api/classes/${classId}/students/import`, { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      // Recarregar alunos e refazer mapa de presenças
      const res2 = await fetch(`/api/classes/${classId}/students`, { cache: "no-store" });
      const data2 = await res2.json().catch(() => ({}));
      if (data2?.ok && Array.isArray(data2.students)) {
        setStudents(data2.students);
        setPresence((prev) => {
    const n: Record<string, boolean> = { ...(prev || {}) };
    for (const st of data2.students) {
      if (!(st.id in n)) n[st.id] = true; // só marca presentes os NOVOS
    }
    return n;
  });
      }
      setUploadName(null);
      setUploadFile(null);
      if (fileRef.current) fileRef.current.value = "";
    } catch (e) {
      const __m = (e && (e as any).message) ? (e as any).message : String(e || "Erro ao importar planilha"); alert(__m);
      console.error(e);
    } finally {
      setImporting(false);
    }
  };

  return (
    <main className="mx-auto max-w-5xl px-4 py-6">
      <nav className="mb-4 text-sm">
        <Link href={`/classes/${classId}/chamadas`} className="text-blue-700 hover:underline">
          Voltar para Chamadas
        </Link>
      </nav>

      <section className="rounded-2xl border bg-white/90 shadow-soft ring-1 ring-black/5">
        <div className="flex flex-wrap items-center justify-between gap-3 border-b px-5 py-4">
          <div>
            <h1 className="text-xl font-semibold text-gray-900">
              Editar chamada <span className="text-gray-500">#{seq}</span> — {className}
            </h1>
            <p className="text-sm text-gray-600">Atualize presenças, cadastre alunos e gerencie esta chamada.</p>
          </div>
          <div className="text-right">
            <div className="text-xs text-gray-500">Nome da aula</div>
            <input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Ex.: Aula 01 - Revisão"
              className="mt-1 w-64 rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
        </div>

        <div className="space-y-5 px-5 py-5">
          {/* Adicionar aluno */}
          {showAdd && (
            <div className="rounded-2xl border bg-blue-50/40 px-4 py-3">
              <div className="grid gap-3 md:grid-cols-3">
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">Nome</label>
                  <input
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    placeholder="Ex.: Maria Silva"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">CPF (opcional)</label>
                  <input
                    value={newCpf}
                    onChange={(e) => setNewCpf(e.target.value)}
                    placeholder="Somente números"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-xs font-medium text-gray-700">Contato (opcional)</label>
                  <input
                    value={newContact}
                    onChange={(e) => setNewContact(e.target.value)}
                    placeholder="Ex.: (48) 99999-9999"
                    className="w-full rounded-xl border border-blue-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                </div>
              </div>
              <div className="mt-3 flex items-center gap-2">
                <button
                  type="button"
                  onClick={handleAddStudent}
                  disabled={adding || newName.trim().length < 2}
                  className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60"
                >
                  {adding ? "Adicionando..." : "Salvar aluno"}
                </button>
                <button
                  type="button"
                  onClick={() => { setShowAdd(false); setNewName(""); setNewCpf(""); setNewContact(""); }}
                  className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
                >
                  Cancelar
                </button>
              </div>
            </div>
          )}

          {/* Lista de presença */}
          <div className="rounded-2xl overflow-hidden border">
            <div className="flex items-center justify-between bg-blue-600 px-4 py-3 text-white">
              <div className="font-semibold">Lista de presença</div>
              <div className="text-sm">Presentes: <b>{totalPresentes}</b> / {students.length}</div>
            </div>

            <div className="flex flex-wrap items-center gap-2 border-b bg-blue-50 px-4 py-2 text-sm">
              <button className="rounded-lg border border-blue-200 px-3 py-1 hover:bg-blue-100" onClick={() => setAll(true)}>Marcar todos</button>
              <button className="rounded-lg border border-blue-200 px-3 py-1 hover:bg-blue-100" onClick={() => setAll(false)}>Desmarcar todos</button>
            </div>

            <div className="grid grid-cols-[32px_1fr_36px] border-b border-blue-200 bg-blue-100/70 text-sm font-medium text-blue-900">
              <div className="px-1.5 py-2 text-center">#</div>
              <div className="px-3 py-2">Aluno</div>
              <div className="px-1.5 py-2 text-center"><span className="sr-only">Presença</span></div>
            </div>

            <div className="max-h-[60vh] overflow-auto">
              {students.length === 0 ? (
                <div className="px-4 py-6 text-sm text-gray-600">Nenhum aluno cadastrado nesta turma.</div>
              ) : students.map((s, idx) => {
                const isEven = idx % 2 === 0;
                return (
                  <div
                    key={s.id}
                    className={[
                      "grid grid-cols-[32px_1fr_36px] items-center text-sm",
                      "border-b border-blue-100",
                      isEven ? "bg-blue-50/40" : "bg-white"
                    ].join(" ")}
                  >
                    <div className="px-1.5 py-2 text-center text-gray-600 tabular-nums">{idx + 1}</div>
                    <div className="px-3 py-2">
                      <div
                        className="font-medium text-gray-900 cursor-pointer select-none"
                        onDoubleClick={() => onDblClickStudent(s)}
                        title="Duplo clique para editar"
                      >
                        {s.name}
                      </div>
                    </div>
                    <div className="px-1.5 py-2 text-center">
                      <label className="inline-flex items-center">
                        <span className="sr-only">Presença de {s.name}</span>
                        <input
                          type="checkbox"
                          className="h-4 w-4 accent-blue-600"
                          checked={!!presence[s.id]}
                          onChange={() => toggleStudent(s.id)}
                          aria-label={`Presença de ${s.name}`}
                        />
                      </label>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Barra de ações — abaixo da lista */}
          <div className="flex flex-wrap items-center gap-2">
            <button
              type="button"
              onClick={handleSave}
              disabled={saving}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90 disabled:opacity-60"
            >
              {saving ? "Salvando..." : "Salvar alterações"}
            </button>

            <button
              type="button"
              onClick={() => setShowAdd((s) => !s)}
              className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
            >
              Adicionar aluno
            </button>

            <button
              type="button"
              onClick={handleDelete}
              disabled={deleting}
              className="rounded-xl border border-red-300 bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100 disabled:opacity-60"
            >
              {deleting ? "Excluindo..." : "Excluir chamada"}
            </button>
          </div>

          {/* Importação (CSV/XLSX) */}
          <div className="rounded-2xl border">
            <div className="border-b px-4 py-3">
              <h3 className="text-sm font-medium text-gray-900">Adicionar alunos por planilha</h3>
              <p className="text-xs text-gray-600 mt-1">
                <b>Apenas o campo "name" é obrigatório</b>. "cpf" e "contact" são opcionais.
              </p>
            </div>

            <div className="grid gap-3 px-4 py-4">
              <div className="flex flex-col items-center justify-center rounded-xl border border-dashed border-blue-300 bg-blue-50/40 px-6 py-8 text-center">
                <p className="text-sm font-medium text-gray-800">Selecione seu arquivo CSV/XLSX</p>
                <p className="text-xs text-gray-500">Formatos aceitos: .csv, .xlsx</p>

                <div className="mt-3 flex flex-wrap items-center justify-center gap-2">
                  <input
                    type="file"
                    accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    className="hidden"
                    id="students-file-input"
                    ref={fileRef}
                    onChange={(e) => {
                      const f = e.target.files?.[0] || null;
                      setUploadName(f ? f.name : null);
                      setUploadFile(f);
                    }}
                  />
                  <label
                    htmlFor="students-file-input"
                    className="cursor-pointer rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600"
                  >
                    Escolher arquivo
                  </label>

                  <button
                    type="button"
                    onClick={__handleImportSend}
                    disabled={!uploadFile || importing}
                    className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60"
                  >
                    {importing ? "Enviando..." : "Enviar planilha"}
                  </button>
                </div>

                {uploadName && <div className="mt-2 text-xs text-gray-700">Selecionado: {uploadName}</div>}

                <div className="mt-4 flex flex-wrap items-center justify-center gap-2 text-sm">
                  <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/students.csv" target="_blank" rel="noreferrer">
                    Baixar modelo CSV
                  </a>
                  <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/students.xlsx" target="_blank" rel="noreferrer">
                    Baixar modelo XLSX
                  </a></div>
              </div>
            </div>
          </div>
        </div>{/* /px-5 py-5 */}
      </section>

      {/* MODAL editar aluno */}
      {editId && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
          <div className="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
            <h2 className="text-lg font-semibold text-gray-900">Editar aluno</h2>
            <div className="mt-3 grid gap-2">
              <label className="text-xs font-medium text-gray-700">Nome</label>
              <input
                value={editName}
                onChange={(e) => setEditName(e.target.value)}
                className="w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-200"
                placeholder="Nome do aluno"
              />
            </div>
            <div className="mt-4 flex items-center gap-2">
              <button
                type="button"
                onClick={handleEditSave}
                className="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
              >
                Salvar
              </button>
              <button
                type="button"
                onClick={() => { setEditId(null); setEditName(""); }}
                className="rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={handleEditDelete}
                className="rounded-xl border border-red-300 bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100"
              >
                Excluir aluno
              </button>
            </div>
          </div>
        </div>
      )}
    </main>
  );
}


===== app/classes/[id]/chamadas/ui.tsx =====
"use client";
import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
type Item = { id: string; seq: number; title: string; createdAt: string };
type Order = "asc" | "desc";

export default function ChamadasClient({ classId }: { classId: string }) {
  const router = useRouter();
  const [items, setItems] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [order, setOrder] = useState<Order>("desc");
  const [error, setError] = useState<string | null>(null);

  async function load() {
    setLoading(true);
    const res = await fetch(`/api/classes/${classId}/chamadas?order=${order}`, { cache: "no-store" });
    if (!res.ok) { setError("Falha ao carregar chamadas"); setLoading(false); return; }
    const data = await res.json();
    setItems(data?.attendances ?? []);
    setLoading(false);
  }
  useEffect(() => { load(); /* eslint-disable-next-line */ }, [order, classId]);

  const sorted = useMemo(() => [...items].sort((a,b)=> order==="asc"? a.seq-b.seq : b.seq-a.seq), [items, order]);

  return (
    <div className="mt-6">
      <div className="flex flex-wrap items-center gap-3">
        <button
          onClick={() => router.push(`/classes/${classId}/chamadas/new`)}
          className="inline-flex items-center gap-2 rounded-2xl bg-white px-5 py-2.5 text-sm font-semibold text-[var(--color-brand-blue)] shadow-sm hover:shadow transition"
        >
          ➕ Nova chamada
        </button>
        <div className="inline-flex items-center gap-2 rounded-2xl bg-white/10 px-3 py-2 text-sm font-medium backdrop-blur">
          <span className="opacity-90">Ordenar por ID:</span>
          <button onClick={()=>setOrder("asc")} className={`rounded-xl px-3 py-1 ${order==="asc"?"bg-white text-[var(--color-brand-blue)] shadow":"text-white/90 hover:bg-white/10"}`}>Crescente</button>
          <button onClick={()=>setOrder("desc")} className={`rounded-xl px-3 py-1 ${order==="desc"?"bg-white text-[var(--color-brand-blue)] shadow":"text-white/90 hover:bg-white/10"}`}>Decrescente</button>
        </div>
      </div>

      <div className="mt-5 bg-white/5 rounded-2xl p-1">
        {loading ? (
          <div className="p-6 text-white/90">Carregando chamadas...</div>
        ) : error ? (
          <div className="p-6 text-red-100">{error}</div>
        ) : sorted.length === 0 ? (
          <div className="p-6 text-white/90">Nenhuma chamada ainda. Crie a primeira.</div>
        ) : (
          <ul className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 p-2">
            {sorted.map((it) => (
              <li key={it.id}>
                <button
                  className="w-full text-left rounded-xl bg-white px-4 py-3 shadow-sm hover:shadow transition border border-white/70"
                  onClick={() => router.push(`/classes/${classId}/chamadas/${it.seq}`)}
                >
                  <div className="text-sm text-[var(--color-brand-blue)] font-semibold">ID #{it.seq}</div>
                  <div className="font-medium">{it.title}</div>
                </button>
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
}


===== app/classes/[id]/conteudos/import/page.tsx =====
import ImportClient from "./ui";

export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  return <ImportClient id={id} />;
}


===== app/classes/[id]/conteudos/import/ui.tsx =====
"use client";
import Link from "next/link";
import { useRef, useState } from "react";

export default function ImportClient({ id }: { id: string }) {
  const [fileName, setFileName] = useState<string | null>(null);
  const [file, setFile] = useState<File | null>(null);
  const [importing, setImporting] = useState(false);
  const inputRef = useRef<HTMLInputElement | null>(null);

  async function handleSend() {
    if (!file) return;
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", file);
      // Rota esperada no backend:
      // POST /api/classes/[id]/conteudos/import -> cria conteúdos e retorna { ok, count }
      const res = await fetch(`/api/classes/${id}/conteudos/import`, { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || "Falha ao importar");
      alert(`Importação concluída: ${data.count || 0} conteúdos criados.`);
    } catch (e: any) {
      console.error(e);
      alert(e?.message || "Erro ao importar");
    } finally {
      setImporting(false);
      setFile(null);
      setFileName(null);
      if (inputRef.current) inputRef.current.value = "";
    }
  }

  return (
    <main className="mx-auto max-w-3xl px-6 py-10">
      <div className="flex items-center justify-between mb-4">
        <Link href={`/classes/${id}/conteudos`} className="rounded-xl border px-4 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600">
          Voltar
        </Link>
      </div>

      <div className="rounded-2xl border bg-white p-6 shadow-sm">
        <h1 className="text-lg font-semibold text-gray-900">Importar conteúdos por planilha</h1>
        <p className="text-sm text-gray-600 mb-4">
          Aceita <b>.csv</b> ou <b>.xlsx</b> com colunas: <code>title</code> (obrigatório) e <code>description</code> (opcional).
        </p>

        <div className="flex flex-wrap items-center gap-2">
          <input
            ref={inputRef}
            type="file"
            accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            className="hidden"
            id="contents-file-input"
            onChange={(e) => {
              const f = e.target.files?.[0] || null;
              setFileName(f ? f.name : null);
              setFile(f);
            }}
          />
          <label
            htmlFor="contents-file-input"
            className="cursor-pointer rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600"
          >
            Escolher arquivo
          </label>
          <button
            type="button"
            onClick={handleSend}
            disabled={!file || importing}
            className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white hover:opacity-90 disabled:opacity-60"
          >
            {importing ? "Enviando..." : "Importar planilha"}
          </button>
          {fileName && <span className="text-sm text-gray-700">Selecionado: {fileName}</span>}
        </div>

        <div className="mt-4 flex flex-wrap gap-2 text-sm">
          <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.csv" target="_blank" rel="noreferrer">
            Baixar modelo CSV
          </a>
          <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.xlsx" target="_blank" rel="noreferrer">
            Baixar modelo XLSX
          </a>
        </div>
      </div>
    </main>
  );
}


===== app/classes/[id]/conteudos/List.tsx =====
"use client";
import Link from "next/link";
import { useEffect, useState } from "react";

type Content = {
  seq: number;
  title: string;
  description: string | null;
  imageUrl: string | null;
};

export default function ConteudosList({ classId }: { classId: string }) {
  const [items, setItems] = useState<Content[]>([]);
  const [loading, setLoading] = useState(true);

  async function load() {
    setLoading(true);
    try {
      const res = await fetch(`/api/classes/${classId}/conteudos`);
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !Array.isArray(data)) throw new Error("Falha ao carregar conteúdos");
      setItems(data);
    } catch (e: any) {
      console.error(e);
      alert(e?.message || "Erro ao carregar conteúdos");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, [classId]);

  if (loading) {
    return (
      <section className="mt-6">
        <div className="rounded-2xl border bg-white p-6 shadow-sm text-sm text-gray-600">Carregando…</div>
      </section>
    );
  }

  return (
    <section className="mt-6">
      {items.length === 0 ? (
        <div className="rounded-2xl border bg-white p-8 shadow-sm text-center text-gray-700">
          Nenhum conteúdo ainda. Use “Importar conteúdos por planilha”.
        </div>
      ) : (
        <ul className="divide-y divide-gray-100 rounded-2xl border bg-white">
          {items.map((c, idx) => (
            <li key={c.seq} className={idx % 2 ? "bg-blue-50/40" : "bg-white"}>
              <Link
                href={`/classes/${classId}/conteudos/${c.seq}`}
                className="group flex items-center justify-between px-4 py-4 hover:bg-blue-50"
              >
                <div className="flex min-w-0 items-center gap-4">
                  <div className="rounded-xl bg-[#0A66FF]/10 px-3 py-1.5 text-xs font-medium text-[#0A66FF]">
                    {c.seq}
                  </div>
                  <div className="min-w-0">
                    <p className="truncate text-sm font-medium text-gray-900">
                      {c.title || `Conteúdo ${c.seq}`}
                    </p>
                    {c.description && (
                      <p className="truncate text-xs text-gray-600">{c.description}</p>
                    )}
                  </div>
                </div>

                <div className="ms-4 shrink-0 rounded-full bg-[#0A66FF]/10 p-2 text-[#0A66FF] transition group-hover:bg-[#0A66FF]/20">
                  <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden>
                    <path fill="currentColor" d="M9 6l6 6l-6 6"/>
                  </svg>
                </div>
              </Link>
            </li>
          ))}
        </ul>
      )}
    </section>
  );
}


===== app/classes/[id]/conteudos/new/page.tsx =====
export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;

  return (
    <main className="mx-auto max-w-4xl px-6 py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-xl font-semibold text-gray-900">Adicionar conteúdo</h1>
        <a
          href={`/classes/${id}/conteudos`}
          className="rounded-xl border px-4 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700"
        >
          Voltar
        </a>
      </div>

      <div className="rounded-2xl border bg-white p-6 shadow-sm">
        <form
          onSubmit={(e) => { e.preventDefault(); alert("Salvar conteúdo: implementar POST /api/classes/[id]/conteudos"); }}
          className="grid gap-4"
        >
          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div>
              <label className="block text-sm font-medium text-gray-700">Aula (nº)</label>
              <input name="lesson" type="number" min={1} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ex.: 1" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">Título <span className="text-red-600">*</span></label>
              <input name="title" required className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ex.: Robótica de introdução" />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Conteúdo da Aula <span className="text-red-600">*</span></label>
            <textarea name="content" required rows={3} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="O que será abordado…"></textarea>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Objetivos</label>
            <textarea name="goals" rows={3} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="- Identificar…&#10;- Compreender…"></textarea>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Desenvolvimento das Atividades</label>
            <textarea name="activities" rows={4} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Passo a passo/roteiro da aula…"></textarea>
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label className="block text-sm font-medium text-gray-700">Recursos Didáticos</label>
              <input name="resources" className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Kit robótico, notebook, projetor…" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">BNCC</label>
              <input name="bncc" className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="EF02TE01; EF05CI06" />
            </div>
          </div>

          <div className="mt-4 flex gap-2">
            <button type="submit" className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90">
              Salvar conteúdo
            </button>
            <a href={`/classes/${id}/conteudos`} className="rounded-xl border px-4 py-2 text-sm font-medium hover:border-blue-400 hover:text-blue-700">
              Cancelar
            </a>
          </div>
        </form>
      </div>

      <div className="mt-6 rounded-2xl border bg-white p-6">
        <p className="text-sm text-gray-600">
          Também é possível <a className="text-[#0A66FF] underline" href={`/classes/${id}/conteudos/import`}>importar conteúdos por planilha</a>.
        </p>
        <div className="mt-3 flex flex-wrap gap-2">
          <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.csv" target="_blank" rel="noreferrer">Baixar modelo CSV</a>
          <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.xlsx" target="_blank" rel="noreferrer">Baixar modelo XLSX</a>
        </div>
      </div>
    </main>
  );
}


===== app/classes/[id]/conteudos/new/ui.tsx =====
"use client";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";

export default function NewClient({ id }: { id: string }) {
  const router = useRouter();
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [saving, setSaving] = useState(false);

  async function handleCreate() {
    if (!title.trim()) {
      alert("Informe o nome da aula");
      return;
    }
    setSaving(true);
    try {
      // 1) Gera imagem via IA
      const gen = await fetch(`/api/images/generate`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ prompt: title.trim() })
      });
      const genData = await gen.json().catch(() => ({}));
      if (!gen.ok || !genData?.url) throw new Error(genData?.error || "Falha ao gerar imagem");

      // 2) Cria o conteúdo
      const res = await fetch(`/api/classes/${id}/conteudos`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          title: title.trim(),
          description: description.trim().length ? description.trim() : undefined,
          imageUrl: genData.url
        })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || "Erro ao criar conteúdo");

      router.replace(`/classes/${id}/conteudos`);
      if (typeof window !== "undefined") {
        window.dispatchEvent(new CustomEvent("conteudo:created"));
      }
    } catch (e: any) {
      alert(e?.message || "Erro ao publicar");
    } finally {
      setSaving(false);
    }
  }

  return (
    <main className="mx-auto max-w-3xl px-6 py-10">
      <div className="flex items-center justify-between mb-4">
        <Link href={`/classes/${id}/conteudos`} className="rounded-xl border px-4 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600">
          Voltar
        </Link>
      </div>

      <div className="rounded-2xl border bg-white p-6 shadow-sm">
        <h1 className="text-lg font-semibold text-gray-900">Novo conteúdo (imagem por IA)</h1>
        <p className="text-sm text-gray-600 mb-4">Somente imagens geradas automaticamente com base no nome da aula.</p>

        <div className="grid gap-3">
          <input
            className="rounded-xl border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-[#0A66FF]"
            placeholder="Nome da aula (obrigatório)"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
          <textarea
            className="rounded-xl border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-[#0A66FF]"
            placeholder="Descrição / objetivo (opcional)"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            rows={3}
          />

          <div>
            <button
              type="button"
              onClick={handleCreate}
              disabled={saving || !title.trim()}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90 disabled:opacity-60"
            >
              {saving ? "Publicando..." : "Publicar com IA"}
            </button>
          </div>
        </div>
      </div>
    </main>
  );
}


===== app/classes/[id]/conteudos/page.tsx =====
"use client";
import Link from "next/link";
import { useEffect, useRef, useState } from "react";
import { useParams } from "next/navigation";

type Item = { id: string; seq: number; title: string };

export default function ConteudosPage() {
  const { id } = useParams<{ id: string }>();
  const [list, setList] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string|null>(null);

  const [open, setOpen] = useState(false);
  const [title, setTitle] = useState("");
  const [objetivos, setObjetivos] = useState("");
  const [desenvolvimento, setDesenvolvimento] = useState("");
  const [recursos, setRecursos] = useState("");
  const [bncc, setBncc] = useState("");
  const [saving, setSaving] = useState(false);

  const fileRef = useRef<HTMLInputElement|null>(null);
  const [fname, setFname] = useState<string|null>(null);
  const [importing, setImporting] = useState(false);

  async function load() {
    if (!id) return;
    setLoading(true); setErr(null);
    try {
      const res = await fetch(`/api/classes/${id}/conteudos`, { cache: "no-store" });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || "Falha ao carregar");
      setList(data.list || []);
    } catch (e:any) {
      setErr(e?.message || "Erro ao carregar");
    } finally {
      setLoading(false);
    }
  }

  useEffect(()=> { load(); }, [id]);

  async function onSave(e: React.FormEvent) {
    e.preventDefault();
    if (!title.trim()) { alert("Nome da aula é obrigatório."); return; }
    setSaving(true);
    try {
      const res = await fetch(`/api/classes/${id}/conteudos`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ title: title.trim(), objetivos, desenvolvimento, recursos, bncc })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || "Falha ao salvar");
      setOpen(false);
      setTitle(""); setObjetivos(""); setDesenvolvimento(""); setRecursos(""); setBncc("");
      await load();
    } catch (e:any) {
      alert(e?.message || "Erro ao salvar");
    } finally {
      setSaving(false);
    }
  }

  async function onImport() {
    const file = fileRef.current?.files?.[0];
    if (!file) return;
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(`/api/classes/${id}/conteudos/import`, { method: "POST", body: fd });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) throw new Error(data?.error || "Falha ao importar");
      await load();
      if (fileRef.current) fileRef.current.value = "";
      setFname(null);
      alert(`Importação concluída: criados ${data.created ?? 0}, atualizados ${data.updated ?? 0}.`);
    } catch(e:any) {
      alert(e?.message || "Erro ao importar");
    } finally {
      setImporting(false);
    }
  }

  return (
    <main className="mx-auto max-w-5xl px-4 py-6 sm:px-6 sm:py-10">
      <div className="mb-6 rounded-2xl border bg-white p-5 sm:p-6">
        <div className="mb-4 flex items-center justify-between">
          <Link href={`/classes/${id}`} className="rounded-xl bg-[#0A66FF] px-4 py-2 text-white shadow hover:opacity-90">Voltar</Link>
        </div>
        <h1 className="text-2xl font-semibold">Conteúdos — <span className="text-[#0A66FF]">Turma</span></h1>
        <p className="mt-1 text-sm text-gray-600">Gerencie os conteúdos desta turma.</p>

        <div className="mt-4">
          <button onClick={()=> setOpen(true)} className="rounded-xl bg-[#0A66FF] px-4 py-2 text-white shadow hover:opacity-90">
            + Adicionar conteúdo
          </button>
        </div>
      </div>

      <div className="rounded-2xl border bg-white">
        {loading ? (
          <p className="p-4 text-sm text-gray-600">Carregando…</p>
        ) : err ? (
          <p className="p-4 text-sm text-red-600">{err}</p>
        ) : list.length === 0 ? (
          <div className="p-4 text-sm text-gray-700">
            Nenhum conteúdo ainda. Clique em <b>Adicionar conteúdo</b> ou importe por planilha abaixo.
          </div>
        ) : (
          <ul className="divide-y">
            {list.map((it)=> (
              <li key={it.id} className="flex items-center justify-between p-4">
                <div className="text-sm">
                  <div className="font-medium">{it.seq} — {it.title}</div>
                </div>
                {/* ✅ agora aponta para /conteudos/[seq] */}
                <Link
                  href={`/classes/${id}/conteudos/${it.seq}`}
                  className="rounded-full border px-3 py-1 text-sm hover:border-blue-400 hover:text-blue-700"
                >
                  Abrir
                </Link>
              </li>
            ))}
          </ul>
        )}
      </div>

      <section className="mt-6 rounded-2xl border bg-white p-5 sm:p-6">
        <h2 className="text-base font-semibold">Enviar conteúdo por planilha</h2>
        <p className="mt-1 text-sm text-gray-600">
          Suporte a CSV (pronto) e XLSX (preparado). Campos: <b>nome da aula (obrigatório)</b>,
          objetivos, desenvolvimento das atividades, recursos pedagógicos e BNCC.
        </p>
        <div className="mt-3 flex flex-wrap items-center gap-2">
          <input
            ref={fileRef}
            type="file"
            accept=".csv,.xlsx"
            id="conteudos-file"
            className="hidden"
            onChange={(e)=> setFname(e.target.files?.[0]?.name ?? null)}
          />
          <label htmlFor="conteudos-file" className="cursor-pointer rounded-xl border px-3 py-2 text-sm hover:border-blue-500 hover:text-blue-600">
            Escolher arquivo (CSV/XLSX)
          </label>
          <button
            onClick={onImport}
            disabled={importing || !fname}
            className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white hover:opacity-90 disabled:opacity-60"
          >
            {importing ? "Enviando..." : "Enviar planilha"}
          </button>
          {fname && <span className="text-xs text-gray-700">Selecionado: {fname}</span>}
          <a className="rounded-xl border px-3 py-1.5 text-sm hover:border-blue-500 hover:text-blue-600" href="/templates/conteudos.csv" target="_blank" rel="noreferrer">
            Baixar modelo CSV
          </a>
          <a className="rounded-xl border px-3 py-1.5 text-sm hover:border-blue-500 hover:text-blue-600" href="/templates/conteudos.xlsx" target="_blank" rel="noreferrer">
            Baixar modelo XLSX
          </a>
        </div>
      </section>

      {/* Modal - igual à versão anterior */}
      {open && (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4">
          <div className="w-full max-w-xl rounded-2xl bg-white p-5 sm:p-6 shadow-lg">
            <h3 className="text-lg font-semibold">Novo conteúdo</h3>
            <p className="text-xs text-gray-500 mb-3">Somente <b>Nome da aula</b> é obrigatório.</p>
            <form onSubmit={onSave} className="space-y-3">
              <div>
                <label className="mb-1 block text-sm">Nome da aula *</label>
                <input className="input" value={title} onChange={(e)=>setTitle(e.target.value)} placeholder="Ex.: Algoritmos — Aula 1" required />
              </div>
              <div>
                <label className="mb-1 block text-sm">Objetivos</label>
                <textarea className="input min-h-[72px]" value={objetivos} onChange={(e)=>setObjetivos(e.target.value)} />
              </div>
              <div>
                <label className="mb-1 block text-sm">Desenvolvimento das atividades</label>
                <textarea className="input min-h-[72px]" value={desenvolvimento} onChange={(e)=>setDesenvolvimento(e.target.value)} />
              </div>
              <div>
                <label className="mb-1 block text-sm">Recursos pedagógicos</label>
                <textarea className="input min-h-[72px]" value={recursos} onChange={(e)=>setRecursos(e.target.value)} />
              </div>
              <div>
                <label className="mb-1 block text-sm">BNCC</label>
                <input className="input" value={bncc} onChange={(e)=>setBncc(e.target.value)} placeholder="Ex.: EF06MA01" />
              </div>
              <div className="flex justify-end gap-2 pt-2">
                <button type="button" onClick={()=> setOpen(false)} className="rounded-xl border px-3 py-2 text-sm">Cancelar</button>
                <button type="submit" disabled={saving} className="rounded-xl bg-[#0A66FF] px-4 py-2 text-white disabled:opacity-60">
                  {saving ? "Salvando..." : "Salvar"}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </main>
  );
}


===== app/classes/[id]/conteudos/[seq]/page.tsx =====
"use client";
import Link from "next/link";
import { useParams, useRouter } from "next/navigation";
import { useEffect, useState } from "react";

type Content = {
  id: string; seq: number; title: string; bodyHtml?: string;
  objetivos?: string; desenvolvimento?: string; recursos?: string; bncc?: string;
};

// Componente de campo editável com overlay que captura double-click
function EditableField({
  label, value, setValue, multiline = false, editing, setEditing, placeholder
}: {
  label: string;
  value: string;
  setValue: (v: string) => void;
  multiline?: boolean;
  editing: boolean;
  setEditing: (v: boolean) => void;
  placeholder?: string;
}) {
  return (
    <div className="relative">
      <label className="mb-1 block text-sm text-gray-600">{label}</label>
      {multiline ? (
        <textarea
          className={`input min-h-[96px] ${editing ? "" : "opacity-70"}`}
          value={value}
          onChange={(e)=> setValue(e.target.value)}
          disabled={!editing}
          placeholder={placeholder}
        />
      ) : (
        <input
          className={`input ${editing ? "" : "opacity-70"}`}
          value={value}
          onChange={(e)=> setValue(e.target.value)}
          disabled={!editing}
          placeholder={placeholder}
        />
      )}
      {/* Overlay: quando não está editando, captura o double-click */}
      {!editing && (
        <button
          type="button"
          aria-label={`Editar ${label}`}
          title="Dê dois cliques para editar"
          onDoubleClick={()=> setEditing(true)}
          className="absolute inset-0 cursor-text"
          // botão invisível
          style={{ background: "transparent" }}
        />
      )}
      {!editing && <p className="mt-1 text-xs text-gray-500">Dê dois cliques para editar</p>}
    </div>
  );
}

export default function ConteudoDetailPage() {
  const { id, seq } = useParams<{ id: string; seq: string }>();
  const router = useRouter();
  const [data, setData] = useState<Content | null>(null);
  const [err, setErr] = useState<string|null>(null);
  const [saving, setSaving] = useState(false);
  const [deleting, setDeleting] = useState(false);

  // flags de edição (double-click liga)
  const [edit, setEdit] = useState<{title:boolean; objetivos:boolean; desenvolvimento:boolean; recursos:boolean; bncc:boolean}>({
    title: false, objetivos: false, desenvolvimento: false, recursos: false, bncc: false
  });

  // valores
  const [title, setTitle] = useState("");
  const [objetivos, setObjetivos] = useState("");
  const [desenvolvimento, setDesenvolvimento] = useState("");
  const [recursos, setRecursos] = useState("");
  const [bncc, setBncc] = useState("");

  function loadLocal(j: Content) {
    setData(j);
    setTitle(j.title || "");
    setObjetivos(j.objetivos || "");
    setDesenvolvimento(j.desenvolvimento || "");
    setRecursos(j.recursos || "");
    setBncc(j.bncc || "");
  }

  useEffect(() => {
    async function run() {
      try {
        const res = await fetch(`/api/classes/${id}/conteudos/${seq}`, { cache: "no-store" });
        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j?.ok) throw new Error(j?.error || "Não encontrado");
        loadLocal(j.content);
      } catch(e:any) {
        setErr(e?.message || "Erro ao carregar conteúdo");
      }
    }
    if (id && seq) run();
  }, [id, seq]);

  async function onSave() {
    setSaving(true);
    try {
      const res = await fetch(`/api/classes/${id}/conteudos/${seq}`, {
        method: "PATCH",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ title, objetivos, desenvolvimento, recursos, bncc })
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j?.ok) throw new Error(j?.error || "Falha ao salvar");
      loadLocal(j.content);
      setEdit({ title:false, objetivos:false, desenvolvimento:false, recursos:false, bncc:false });
      alert("Conteúdo atualizado.");
    } catch(e:any) {
      alert(e?.message || "Erro ao salvar");
    } finally {
      setSaving(false);
    }
  }

  async function onDelete() {
    if (!confirm("Tem certeza que deseja excluir este conteúdo?")) return;
    setDeleting(true);
    try {
      const res = await fetch(`/api/classes/${id}/conteudos/${seq}`, { method: "DELETE" });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j?.ok) throw new Error(j?.error || "Falha ao excluir");
      router.push(`/classes/${id}/conteudos`);
    } catch(e:any) {
      alert(e?.message || "Erro ao excluir");
    } finally {
      setDeleting(false);
    }
  }

  return (
    <main className="mx-auto max-w-3xl px-6 py-10">
      <div className="mb-6 flex items-center justify-between">
        <Link href={`/classes/${id}/conteudos`} className="rounded-xl border px-3 py-2 text-sm hover:border-blue-400 hover:text-blue-700">
          Voltar
        </Link>
        {data && <div className="text-sm text-gray-500">Aula {data.seq}</div>}
      </div>

      {err ? (
        <p className="text-sm text-red-600">{err}</p>
      ) : !data ? (
        <p className="text-sm text-gray-600">Carregando…</p>
      ) : (
        <section className="space-y-4 rounded-2xl border bg-white p-6">
          <EditableField
            label="Nome da aula"
            value={title}
            setValue={setTitle}
            editing={edit.title}
            setEditing={(v)=> setEdit(s=> ({...s, title:v}))}
            placeholder="Ex.: Algoritmos — Aula 1"
          />
          <EditableField
            label="Objetivos"
            value={objetivos}
            setValue={setObjetivos}
            editing={edit.objetivos}
            setEditing={(v)=> setEdit(s=> ({...s, objetivos:v}))}
            multiline
          />
          <EditableField
            label="Desenvolvimento das atividades"
            value={desenvolvimento}
            setValue={setDesenvolvimento}
            editing={edit.desenvolvimento}
            setEditing={(v)=> setEdit(s=> ({...s, desenvolvimento:v}))}
            multiline
          />
          <EditableField
            label="Recursos pedagógicos"
            value={recursos}
            setValue={setRecursos}
            editing={edit.recursos}
            setEditing={(v)=> setEdit(s=> ({...s, recursos:v}))}
            multiline
          />
          <EditableField
            label="BNCC"
            value={bncc}
            setValue={setBncc}
            editing={edit.bncc}
            setEditing={(v)=> setEdit(s=> ({...s, bncc:v}))}
            placeholder="Ex.: EF06MA01"
          />

          <div className="flex items-center justify-between pt-2">
            <button
              onClick={onDelete}
              disabled={deleting}
              className="rounded-xl border px-4 py-2 text-red-600 border-red-600 hover:bg-red-50 disabled:opacity-60"
            >
              Excluir
            </button>
            <button
              onClick={onSave}
              disabled={saving}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-white disabled:opacity-60"
            >
              Salvar
            </button>
          </div>
        </section>
      )}
    </main>
  );
}


===== app/classes/[id]/conteudos/ui.tsx =====
"use client";

import { useRef, useState } from "react";

export function ImportContentsBox({ classId }: { classId: string }) {
  const [uploadFile, setUploadFile] = useState<File | null>(null);
  const [uploadName, setUploadName] = useState<string | null>(null);
  const [importing, setImporting] = useState(false);
  const fileRef = useRef<HTMLInputElement>(null);

  async function handleImportSend() {
    if (!uploadFile) return;
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", uploadFile);
      const res = await fetch(`/api/classes/${classId}/conteudos/import`, {
        method: "POST",
        body: fd,
      });

      let errorMsg = "Erro ao importar conteúdos";
      let data: any = null;
      try { data = await res.json(); } catch {}
      if (!res.ok || !data?.ok) {
        if (data?.error) {
          if (typeof data.error === "string") errorMsg = data.error;
          else if (data.error?.formErrors?.formErrors?.length) errorMsg = data.error.formErrors.formErrors.join("\n");
          else if (data.error?.fieldErrors) errorMsg = JSON.stringify(data.error.fieldErrors);
        }
        throw new Error(errorMsg);
      }

      // sucesso: recarrega a lista
      setUploadFile(null);
      setUploadName(null);
      if (fileRef.current) fileRef.current.value = "";
      window.location.reload();
    } catch (e: any) {
      alert(e?.message || "Erro ao importar conteúdos");
      console.error(e);
    } finally {
      setImporting(false);
    }
  }

  return (
    <section className="mt-8 rounded-2xl border bg-white">
      <div className="border-b px-5 py-5">
        <h3 className="text-sm font-semibold text-gray-900">Importar conteúdos por planilha</h3>
        <p className="mt-1 text-xs text-gray-600">
          Formatos aceitos: <b>.csv</b>, <b>.xlsx</b>. Mantenha o cabeçalho: <b>Aula, Título, Conteúdo da Aula, Objetivos, Desenvolvimento das Atividades, Recursos Didáticos, BNCC</b>.
        </p>
      </div>

      <div className="px-5 py-5">
        <div className="flex flex-col items-center justify-center rounded-xl border border-dashed border-blue-300 bg-blue-50/40 px-6 py-8 text-center">
          <p className="text-sm font-medium text-gray-800">Selecione seu arquivo CSV/XLSX</p>
          <p className="text-xs text-gray-500">Formatos aceitos: .csv, .xlsx</p>

          <div className="mt-3 flex flex-wrap items-center justify-center gap-2">
            <input
              ref={fileRef}
              type="file"
              accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
              className="hidden"
              id="contents-file-input"
              onChange={(e) => {
                const f = e.target.files?.[0] || null;
                setUploadName(f ? f.name : null);
                setUploadFile(f);
              }}
            />
            <label
              htmlFor="contents-file-input"
              className="cursor-pointer rounded-xl border px-3 py-2 text-sm font-medium hover:border-blue-500 hover:text-blue-600"
            >
              Escolher arquivo
            </label>

            <button
              type="button"
              onClick={handleImportSend}
              disabled={!uploadFile || importing}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white hover:opacity-90 disabled:opacity-60"
            >
              {importing ? "Enviando..." : "Enviar planilha"}
            </button>
          </div>

          {uploadName && (
            <div className="mt-2 text-xs text-gray-700">Selecionado: {uploadName}</div>
          )}

          <div className="mt-4 flex flex-wrap items-center justify-center gap-2 text-sm">
            <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.csv" target="_blank" rel="noreferrer">
              Baixar modelo CSV
            </a>
            <a className="rounded-xl border px-3 py-1.5 hover:border-blue-500 hover:text-blue-600" href="/templates/contents.xlsx" target="_blank" rel="noreferrer">
              Baixar modelo XLSX
            </a>
          </div>
        </div>
      </div>
    </section>
  );
}


===== app/classes/[id]/page.tsx =====
import Link from "next/link";
import { notFound } from "next/navigation";
import { prisma } from "@/lib/prisma";

export const dynamic = "force-dynamic";

export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;

  const cls = await prisma.class.findFirst({
    where: { id },
    select: { id: true, name: true }
  });
  if (!cls) return notFound();

  return (
    <main className="min-h-screen">
      {/* Cabeçalho */}
      <section className="bg-gradient-to-br from-[#0A66FF]/90 to-[#0A66FF] text-white">
        <div className="max-w-5xl mx-auto px-6 py-8 flex items-center justify-between gap-3">
          <Link
            href={`/dashboard`}
            className="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2 text-sm font-medium text-white hover:bg-white/25 focus:outline-none focus:ring-2 focus:ring-white/60"
          >
            Voltar
          </Link>

          <div className="text-right">
            <h1 className="text-xl font-semibold">
              Turma — <span className="opacity-95">{cls.name}</span>
            </h1>
            <p className="mt-1 text-sm opacity-90">Gerencie a turma acessando Chamadas e Conteúdos.</p>
          </div>
        </div>
      </section>

      {/* Corpo (sem links superiores redundantes) */}
      <section className="max-w-5xl mx-auto px-6 py-8">
        <div className="rounded-2xl border bg-white p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-2 text-gray-900">Ações</h2>
          <p className="text-gray-600 mb-4">Use os atalhos abaixo para gerenciar a turma.</p>
          <div className="flex flex-wrap gap-2">
            <Link
              href={`/classes/${cls.id}/chamadas`}
              className="rounded-xl bg-[#0A66FF] px-4 py-2 text-sm font-medium text-white shadow hover:opacity-90"
            >
              Ir para Chamadas
            </Link>
            <Link
              href={`/classes/${cls.id}/conteudos`}
              className="rounded-xl border px-4 py-2 text-sm font-medium text-gray-800 hover:border-blue-400 hover:text-blue-700"
            >
              Ver Conteúdos
            </Link>
          </div>
        </div>
      </section>
    </main>
  );
}


===== app/classes/[id]/StudentsPanel.tsx =====
"use client";
import { useEffect, useRef, useState } from "react";

type Student = { id: string; name: string; cpf: string; contact: string };

export default function StudentsPanel({ classId }: { classId: string }) {
  const [openAdd, setOpenAdd] = useState(false);
  const [form, setForm] = useState({ name: "", cpf: "", contact: "" });
  const [saving, setSaving] = useState(false);
  const [list, setList] = useState<Student[] | null>(null);
  const fileRef = useRef<HTMLInputElement|null>(null);
  const [importing, setImporting] = useState(false);

  async function load() {
    const res = await fetch(`/api/classes/${classId}/students`, { cache: "no-store" });
    const data = await res.json().catch(() => null);
    if (res.ok && data?.ok) setList(data.students as Student[]);
    else setList([]);
  }
  useEffect(() => { load(); }, [classId]);

  async function onAdd(e: React.FormEvent) {
    e.preventDefault();
    setSaving(true);
    try {
      const res = await fetch(`/api/classes/${classId}/students`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(form)
      });
      const data = await res.json();
      if (!res.ok || !data?.ok) {
        alert(data?.error ?? "Erro ao adicionar");
      } else {
        setList(prev => prev ? [data.student as Student, ...prev] : [data.student as Student]);
        setOpenAdd(false);
        setForm({ name: "", cpf: "", contact: "" });
      }
    } catch {
      alert("Falha de rede");
    } finally {
      setSaving(false);
    }
  }

  async function onImport(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0];
    if (!file) return;
    setImporting(true);
    try {
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(`/api/classes/${classId}/students/import`, { method: "POST", body: fd });
      const data = await res.json();
      if (!res.ok || !data?.ok) {
        alert(data?.error ?? "Erro ao importar");
      } else {
        setList(prev => prev ? [...data.students, ...prev] : data.students);
        alert(`Importados: ${data.createdCount}`);
      }
    } catch {
      alert("Falha de rede");
    } finally {
      setImporting(false);
      if (fileRef.current) fileRef.current.value = "";
    }
  }

  return (
    <section className="card p-6 mt-6">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold">Alunos</h2>
        <div className="flex gap-2">
          <button onClick={() => setOpenAdd(true)} className="btn-primary">Adicionar aluno</button>
          <label className="rounded-xl border px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer">
            {importing ? "Importando..." : "Importar CSV/XLSX"}
            <input ref={fileRef} onChange={onImport} type="file" accept=".csv,.xlsx" className="hidden" />
          </label>
          <a className="rounded-xl border px-3 py-2 text-sm hover:bg-gray-50" href="/templates/students.csv" target="_blank">Modelo CSV</a>
          <a className="rounded-xl border px-3 py-2 text-sm hover:bg-gray-50" href="/templates/students.xlsx" target="_blank">Modelo XLSX</a>
        </div>
      </div>

      {/* Lista */}
      <div className="mt-4">
        {list === null ? (
          <div className="text-gray-600">Carregando...</div>
        ) : list.length === 0 ? (
          <div className="text-gray-600">Nenhum aluno cadastrado.</div>
        ) : (
          <ul className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {list.map(s => (
              <li key={s.id} className="rounded-xl border p-4 bg-gradient-to-br from-[var(--color-brand-blue)]/10 to-[var(--color-brand-blue)]/5">
                <div className="font-medium">{s.name}</div>
                <div className="text-xs text-gray-600 mt-1">CPF: {s.cpf || "-"}</div>
                <div className="text-xs text-gray-600">Contato: {s.contact || "-"}</div>
              </li>
            ))}
          </ul>
        )}
      </div>

      {/* Drawer de adicionar */}
      {openAdd && (
        <div className="mt-6 rounded-2xl border p-4">
          <h3 className="font-semibold mb-3">Adicionar aluno</h3>
          <form onSubmit={onAdd} className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="sm:col-span-2">
              <label className="block text-sm mb-1">Nome</label>
              <input className="input w-full" required
                     value={form.name}
                     onChange={e=>setForm(f=>({...f, name:e.target.value}))} />
            </div>
            <div>
              <label className="block text-sm mb-1">CPF</label>
              <input className="input w-full"
                     value={form.cpf}
                     onChange={e=>setForm(f=>({...f, cpf:e.target.value}))}
                     placeholder="000.000.000-00" />
            </div>
            <div>
              <label className="block text-sm mb-1">Contato</label>
              <input className="input w-full"
                     value={form.contact}
                     onChange={e=>setForm(f=>({...f, contact:e.target.value}))}
                     placeholder="(11) 90000-0000" />
            </div>
            <div className="sm:col-span-2 flex gap-2">
              <button type="submit" disabled={saving} className="btn-primary">
                {saving ? "Salvando..." : "Salvar"}
              </button>
              <button type="button" onClick={()=>setOpenAdd(false)} className="rounded-xl px-3 py-2 text-sm border">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      )}
    </section>
  );
}


===== app/dashboard/page.tsx =====
"use client";
import { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";

type Me = { ok: boolean; user?: { id: string; name: string; email: string } };
type ClassItem = { id: string; name: string; createdAt: string };

export default function DashboardPage() {
  const router = useRouter();
  const [me, setMe] = useState<Me | null>(null);
  const [loading, setLoading] = useState(true);
  const [classes, setClasses] = useState<ClassItem[]>([]);
  const [name, setName] = useState("");
  const [err, setErr] = useState<string | null>(null);

  async function fetchMe() {
    const res = await fetch("/api/auth/me");
    if (res.status === 401) {
      router.push("/login");
      return;
    }
    const data: Me = await res.json();
    setMe(data);
  }

  async function fetchClasses() {
    const res = await fetch("/api/classes");
    if (res.status === 401) {
      router.push("/login");
      return;
    }
    const data = await res.json();
    if (data?.ok) setClasses(data.classes || []);
  }

  useEffect(() => {
    (async () => {
      await fetchMe();
      await fetchClasses();
      setLoading(false);
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  async function onLogout() {
    await fetch("/api/auth/logout", { method: "POST" });
    router.push("/login");
  }

  async function onCreateClass(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    const n = name.trim();
    if (n.length < 2) {
      setErr("Nome da turma muito curto.");
      return;
    }
    const res = await fetch("/api/classes", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ name: n })
    });
    const data = await res.json();
    if (!res.ok || !data?.ok) {
      setErr(data?.error ?? "Erro ao criar turma");
      return;
    }
    setName("");
    // recarrega lista
    await fetchClasses();
  }

  if (loading) {
    return <main className="min-h-screen flex items-center justify-center">Carregando...</main>;
  }

  const firstName = me?.user?.name?.split(" ")[0] || "Olá";

  return (
    <main className="min-h-screen p-6 lg:p-10">
      <header className="flex items-center justify-between max-w-5xl mx-auto mb-8">
        <div className="flex items-center gap-3">
          <span className="inline-block h-4 w-4 rounded-full bg-[var(--color-brand-blue)]" />
          <h1 className="text-2xl font-semibold">EDUCC • Dashboard</h1>
        </div>
        <button onClick={onLogout} className="btn-primary">Sair</button>
      </header>

      <section className="max-w-5xl mx-auto">
        <div className="card p-6 mb-8">
          <h2 className="text-xl font-semibold">{firstName}, bem-vindo(a)!</h2>
          <p className="text-gray-600">Gerencie suas turmas abaixo.</p>
        </div>

        <div className="card p-6 mb-6">
          <h3 className="font-semibold mb-3">Criar nova turma</h3>
          <form onSubmit={onCreateClass} className="flex flex-col sm:flex-row gap-3">
            <input
              className="input flex-1"
              type="text"
              placeholder="Nome da turma"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
              minLength={2}
            />
            <button type="submit" className="btn-primary">Criar turma</button>
          </form>
          {err && <p className="text-sm text-red-600 mt-2">{err}</p>}
        </div>

        <div className="card p-6">
          <h3 className="font-semibold mb-4">Minhas turmas</h3>
          {classes.length === 0 ? (
            <p className="text-gray-600">Nenhuma turma cadastrada ainda.</p>
          ) : (
            <ul className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {classes.map((c) => (
                <li key={c.id}>
                  <Link
                    href={`/classes/${c.id}`}
                    className="block p-4 border border-gray-200 rounded-xl hover:shadow-md transition-shadow"
                  >
                    <div className="font-medium">{c.name}</div>
                    <div className="text-xs text-gray-500 mt-1">
                      {new Date(c.createdAt).toLocaleString()}
                    </div>
                  </Link>
                </li>
              ))}
            </ul>
          )}
        </div>
      </section>
    </main>
  );
}


===== app/favicon.ico =====
         (  F          (  n  00     (-             F  (                                                           $   ]         ]   $                                                                                       8                                 8                                                                                                               #         OOOggg            #   Y         555            Y               kkk                              			                  Y               JJJkkk                  Y   #               			                  #                      111DDD                                                                                   8                                 8                                                                                       $   ]         ]   $                                                                                                                                                                                                                                                                                    (       @                                                                               ,   U               U   ,                                                                                      *                                       *                                                                                                                                                                             Q                                                         Q                                               r                                                               r                                       r                                                                     r                               O                                                                           O                                                                                                                                                                                                                           (                                                                                       '                             888___                                                 SSS                           +                        hhh                           +   T                        ,,,                           T                              GGG                                                                                                                              +++jjj                                                                                                         T                                 III                                    T   +                                    hhh                                    +                                       ,,,                                                                                  GGG                                                  '                                                                              (                                                   333___                                                                                                                                                                  O                                                                           O                               r                                                                     r                                       r                                                               r                                               Q                                                         Q                                                                                                                                                                             *                                       *                                                                                      ,   U               U   ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (   0   `           -                                                                                             	   (   L   j               j   K   (   	                                                                                                                                          V                                             U                                                                                                                      %                                                               &                                                                                                                                                                                                                                                                     Q                                                                                 R                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         P                                                                                                                     O                                                                                                                                                                                                                                                                                                                                       #                                                                                                                                 #                                                                                                                                                                                                 $$$hhheeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeePPP                                         U                              sss                                 U                                            eee                                        	                                    HHH                                       	   (                                       EEE                                          (   K                                          ,,,                                          L   j                                          )))                                             j                                                                                                                                             iii                                                                                                   eee                                                                                                   HHH                                                      j                                                   EEE                                                      j   L                                                      ,,,                                                      K   (                                                      )))                                                         (   	                                                                                                                  	                                                             iii                                                                    U                                                         eee                                                         U                                                                    HHH                                                                                                                                    EEE                                                                               #                                                            ,,,                                                            #                                                                                222}}}                                                                                                                                                                                                                                                 O                                                                                                                     P                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         R                                                                                 Q                                                                                                                                                                                                                                                                     &                                                               %                                                                                                                      U                                             V                                                                                                                                          	   (   K   j               j   L   (   	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PNG

   IHDR         \rf   sRGB    8eXIfMM *    i                              D"8s  IDATx]	ՙn]<QVAh$	N13*qdčIDL2((Ԙ2ęG	q_@屈xțЏ{oU{}O;9d(Dg8	N ]@hx?v N3=`;6.&u  6Pн@àR PiZq^DNwpXhИHg@
:|5` p"@'ɲs{p*2 d ү|(0
0 >K
xX6 IJ C|?$KEN}ϓ|h $	2 |/ . Nz #We
5ܶ;y  gsh^  I DL(;8HjgcH|x1R"aӁ G@9`/`%0H@j~,K
,t).IDTO)~Vu$b 誛U%7 _$b 8AJ3` 510wQ?vr:2K@ v*{%#AZ咁^(=g \W!:,`6643:@c.Fٟu?<'_܏vp: 8Q
IŁp{3kHȢGcѼ<62&
2uC敭T3
;d/~m.X@{w.d]G {lKEb(PRuMTCd])_Lm==@bKGUk^U)1gTm`9\Q@Ⱆ6:ڞ^wED 	5F,
X"dm<nB~@ttx;f>I88C1۪$Be+jlEZ& S::6m\G1`!nllƊ^Q`@OcS@eͷqbpS@upFD@Г2@#L3 A$H2 _hFH#rq(OD򤬈runGOWab &SgD3EDto*Ǥ9k~),$ xR1vK 9D䍁U(w&LEꩻS)3Y8x8 $.i(KŀYa]4ǀ	c@3f4 Ƣ/*b $!I~7B*-1`	o  	$ǡDL J"OQ)2@#x4"$e I8Oi8" G8[xt<.7&m&؎R^tq ؕ.Y-2 d *_&d|j\Wb G*g 釁F4"I؃/ b1qNYDp9p}w\ Ԥ1 j`OxK=H A1#
D:U8jt$b bA||UQ26%)1 _ꢳ!~D +b >A:]E$50GDhRtݻwR)P n$ 3@bSNu,Yjʲ:;@`|-[)'OVՆsFxڮۥn}͛7~ƺ:QJ_UKj8q0x;v4 ̞=[hW=		&!e58hѢEw]6_iW}SZ?	/`;vl}2 <h" A܁X,m۶+V(<w#F^;aHc )S*{apc89(^4&EoÆW/u=^*?{k^_Ezg UI-{WU*
:p9.tڷo(/ݺus>3'^RgڞGI_D~~ {?N07S.ƍ׸~?}/y]nA;أ2 ]FOB2C?_I[::=#OzK- ϣ%?jIPۯ{N-hUt: ,GK-hUchP7 @n?\-k.2: `F=-V_G܂V }0 WIFʭsMrZ8pJQ*@OK8
rZݖa, w SW^y.5at7ݏTv#~7nA"+WpM/hK8gF/^M{e R|)q7t?8'KP~瞰\r>ǷUk eP|^x
/V/v*pv ʟ]J}k8(ĉѣGǗOmڴq,Xoe.^ Qxpt4^_N{y2 s -عsgsivZ8
!~PJ?c|] ܽ{z긓R1pnztlp9frvjT殿z4*OL~ԕ34~~r;mxY+3 r;mx4:7]ՁqL4)U!r1u6$78w̙3Ǹ|5>?\zO͆ ,E32[2Wu:E^p.H1cJt]}BuSOuIcO%  AZkD?5 @Q3w+"TSUޥ13?5 M'݋>pZj~fj׈סԐn> i5D[bf ~a'`Xc -1kāIkQů|kM(92@t݂X-LדaN4qܞ'$f0@@VnAܘYL9:|/^s 	)0`jT\wuZ-¨\	@:ct{-Rb1% I,Y%T~r1C,$*ˀf<0zhF |8Z-CRTg HRfglYs-p'+m_ؒgC{ 	ȪϏΙ3g-GR|׹7`G񥡘0U_ٵZЏدD)\>ʗz N@~~-P{rs@<|.]Ը|m|g_yWKD1bM%s\r1n\ƒ"- `.4~%3I}[0A$= ->BH"Gۏ^r<EBGi %9@^~~@1@ t-[{%@C$mAgΚ5kʆх/双OlӿB@.XupO6x9MPn`߷o_^n`t
(\rsAyۂT@h
E0l0;tڵӘkƸNYjU
S#|^㽺- |pN.ޥ`^{zL64 ěbe]&"dsΜ9UޥU0!*nP*`o֨vi8Ghhmɓs={JU0ՂwZ8bEz,YD![C>}7:k׮nof >jvR?#bX(FATFi[{zv>Ca+[0B2D=G~(
ĺLO\s܂>"8|`[)
&Lp8'4 oGe#ۏlْ_\D̀܂2Zli9tȑ9f ޢ-=Yyn?uQ}XͬsAi >=1=R+ +܂.2 KCƢۃ20h ˫%535@MA%̣j[9; _(0~r\{mPx#TT9n?N#ץ&} )
TVL!j`p 8@RrUAVA=-pLH`@n*Ȋ1܂U?}w ]H2@ߴiV[˯%5 8)Э
T`|rZbZ-.!da+@ ߞZgf[0p  Igr$o%P_rCyV|߽"mY-[ lk xA ۯ9][pҤIȨpPk FeِgHEdnAm"Z$5}z82rX| SܻwrJsJ~Tfz{ ͫ xj?jQEn js|Gxз<dXt(QE.p47 );ys_VD-XTi? ~薜 `Q=V?^
.]|X
mB~?J D~h rERA݀B~wqӾ}<ŕ[й5d-`5 ?Kq~l40@)/I(؋n9Y4!Cو2ח*w9GKݐs&res?68J |(uwO䴁d&K)nA?Rn@7,8=renM69kM7JR]en9Z /?នo>󕾤rzr `V{u4448Vrap QRZ<{dK.F9#~Ts.N%* Ýu8G&/W:*x%{}@ lNc#AIi*?د0}gC"Āpۯ4薒ҏ(b8_QY r7'` j 6 *3Wg"l1:Sg}% 	P?1`Y "D0b@ 9[tF1p`k\U`RA#W81 e`)RZM [uF0	rq. #^=C"Ā9P'R~f 
pnzdC"e?\K@&$b }jz3۵ x/{1 Ra#|ƟUK= &^TMn295)?s{O'DDo [kMoK0x Td_@]b r G; DD1gaR`'`0  >\/fŀ!fnZ|bU.tटr9+	b rnEDk= 8!b RClPE`܌K'~@}*!`@6 L;	$b@D?#gF
V1v;EsQ=ɮ4b@Tn!3q0^V c 1ܶ[M=8I1@څ@Cu`No WJĀ WeI nNmீܴ_d(4`E܅I "̵1 *3+\E \M)g	r
8>p?vI 0ǀ~!b$'%"IRi1 0? S~& r{ n_L?TeƎ7C"rOQ~"qI O 8?$b ܋r#@_vJ̙/3'd/W[o'Nl-2 @jO~02` H@؄+pOB uO(lSԕ9~c:x/Xd.Ɣd Vy@F $H2 +M*il8O@F $H2 24& rPO֢7NYS Y1`;JS3n g['@W@"la`32n?'HB2p
hāmmu j@F@VZ!xIHyѱ)>Z!6 a`dDV$9f	pM6I!LG:\LdrwPy~P%L37TKAmmo|6	3-h J3?67 yr"g4. $1_[*&S/dqCh 3>6Ŷ%\#RZq=lK|ŔXXWSe j5 /$:v@8d1(z2~F)3͋lC#=.\Lt? % N$9b%:2u	 1|-	ldt $b@?@ Fcρ^Dd[9ࠐz:
H@ P2v )~@z5|Rֵ|`#W39؂<"-0\<duoGLz 1Gpe倯d .jH@jF3@ c{s<J&	@bw   nv< ,M;*p>p!0hH{=x]I DLh<'h8@V #Jf I HnW}Nt[u$ @ 2 	]&) #3,	=%Tk&  IIӳ [8		L]]tTg6-@b2 UOV: A?} .i|	xCrvw; #>i 8_b82 WP  {'n8z;Ƥys @Po|Sih $3@߹j    IENDB`

===== app/globals.css =====
@import "tailwindcss";

@theme {
  --color-brand-blue: #0A66FF;
  --shadow-card: 0 1px 2px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.08);
  --radius-xl: 0.75rem;
}

:root { color-scheme: light; }
html, body { height: 100%; }

.btn-primary {
  @apply px-6 py-3 font-semibold text-white disabled:opacity-50;
  background-color: var(--color-brand-blue);
  border-radius: var(--radius-xl);
}
.input {
  @apply w-full border border-gray-200 px-4 py-3 outline-none focus:ring-2;
  border-radius: var(--radius-xl);
  --tw-ring-color: color-mix(in oklab, var(--color-brand-blue) 40%, transparent);
}
.card {
  @apply bg-white border border-gray-100;
  border-radius: calc(var(--radius-xl) * 1.333);
  box-shadow: var(--shadow-card);
}


===== app/layout.tsx =====
import "./globals.css";
export { metadata, viewport } from "./metadata";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="pt-BR"><head><link rel="manifest" href="/manifest.webmanifest" /></head><body>{children}</body>
    </html>
  );
}


===== app/layout.tsx.bak_pwa_1760138407 =====
import type { Metadata } from "next";
import Script from "next/script";
import "./globals.css";

export const metadata: Metadata = {
  title: "EDUCC",
  description: "Sua plataforma educacional — PWA",
  manifest: "/manifest.json",
  applicationName: "EDUCC"
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  const isDev = process.env.NODE_ENV !== "production";
  return (
    <html lang="pt-BR">
      <body className="bg-white text-gray-900 antialiased">
        {isDev && (
          <Script id="dev-sw-killer" strategy="beforeInteractive">
            {`
              (function(){
                if (typeof window === 'undefined') return;
                // Unregister todos os SW (roda antes da hidratação)
                if ('serviceWorker' in navigator) {
                  navigator.serviceWorker.getRegistrations()
                    .then(regs => regs.forEach(r => r.unregister().catch(()=>{})))
                    .catch(()=>{});
                }
                // Limpa caches registrados (Workbox / next-pwa)
                if ('caches' in window) {
                  caches.keys()
                    .then(keys => keys.forEach(k => caches.delete(k).catch(()=>{})))
                    .catch(()=>{});
                }
              })();
            `}
          </Script>
        )}
        {children}
      </body>
    </html>
  );
}


===== app/manifest.webmanifest/route.ts =====
import { NextResponse } from "next/server";

export const dynamic = "force-static"; // permite cache estático em prod

export async function GET() {
  const manifest = {
    name: "EDUCC",
    short_name: "EDUCC",
    id: "/",
    start_url: "/?source=pwa",
    scope: "/",
    display: "standalone",
    display_override: ["standalone", "minimal-ui"],
    background_color: "#ffffff",
    theme_color: "#0A66FF",
    description: "App EDUCC",
    icons: [
      { src: "/icons/icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: "/icons/icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ]
  };

  return NextResponse.json(manifest, {
    headers: { "Content-Type": "application/manifest+json" }
  });
}


===== app/metadata.ts =====
import type { Metadata, Viewport } from "next";

export const metadata: Metadata = {
  title: "EDUCC",
  description: "App EDUCC",
  applicationName: "EDUCC",
  manifest: "/manifest.webmanifest",
  icons: {
    icon: [{ url: "/icons/icon-192.png", sizes: "192x192" }],
    apple: "/apple-touch-icon.png"
  },
  appleWebApp: {
    capable: true,
    statusBarStyle: "default",
    title: "EDUCC"
  }
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  viewportFit: "cover",
  themeColor: "#0A66FF"
};


===== app/metadata.ts.bak_theme_1760144647 =====
import type { Metadata, Viewport } from "next";

export const metadata: Metadata = {
  title: "EDUCC",
  description: "App EDUCC",
  applicationName: "EDUCC",
  manifest: "/manifest.webmanifest",
  icons: {
    icon: [{ url: "/icons/icon-192.png", sizes: "192x192" }],
    apple: "/apple-touch-icon.png"
  },
  appleWebApp: {
    capable: true,
    statusBarStyle: "default",
    title: "EDUCC"
  }
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  viewportFit: "cover"
};


===== app/offline/page.tsx =====
export const metadata = { title: "Offline • EDUCC" };

export default function Offline() {
  return (
    <main className="min-h-screen flex items-center justify-center p-8 text-center">
      <div>
        <h1 className="text-2xl font-semibold">Você está offline</h1>
        <p className="text-gray-600 mt-2">Alguns recursos podem não estar disponíveis sem conexão.</p>
      </div>
    </main>
  );
}


===== app/page.tsx =====
import LoginCard from "@/components/LoginCard";

export default function Home() {
  return (
    <main className="min-h-screen grid grid-cols-1 lg:grid-cols-2">
      {/* Hero azul (desktop) */}
      <section className="hidden lg:flex items-center justify-center bg-brand-blue text-white">
        <div className="max-w-xl px-8">
          <h2 className="text-4xl font-extrabold leading-tight">
            Bem-vindo(a) ao <br /> EDUCC
          </h2>
          <p className="mt-4 text-white/90">
            Sua plataforma educacional — instalável como app (PWA) em Web, Android e iOS.
          </p>
        </div>
      </section>

      {/* Coluna do formulário */}
      <section className="flex items-center justify-center p-6 lg:p-12">
        <LoginCard />
      </section>
    </main>
  );
}
